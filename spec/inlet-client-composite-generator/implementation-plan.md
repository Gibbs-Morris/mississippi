# Implementation Plan

## Status: READY

## Overview

Create a source generator that emits a composite registration method consolidating all Inlet client setup.

**Input**: Assembly attribute `[GenerateInletClientComposite(AppName = "Spring")]`

**Output**: `SpringInletRegistrations.AddSpringInlet()` extension method that calls:
1. All discovered `Add{Aggregate}AggregateFeature()` methods
2. `AddReservoirBlazorBuiltIns()`
3. `AddInletClient()` + `AddInletBlazorSignalR(...)` with auto-scanning

## Phase 1: Attribute Definition

### Step 1.1: Create `GenerateInletClientCompositeAttribute`

**File**: `src/Inlet.Generators.Abstractions/GenerateInletClientCompositeAttribute.cs`

```csharp
namespace Mississippi.Inlet.Generators.Abstractions;

[AttributeUsage(AttributeTargets.Assembly)]
public sealed class GenerateInletClientCompositeAttribute : Attribute
{
    public required string AppName { get; init; }
    public string HubPath { get; init; } = "/hubs/inlet";
}
```

## Phase 2: Generator Implementation

### Step 2.1: Create `InletClientCompositeGenerator`

**File**: `src/Inlet.Client.Generators/InletClientCompositeGenerator.cs`

Pattern:
1. Look for assembly attribute `[GenerateInletClientComposite]`
2. Extract `AppName` and `HubPath` from attribute
3. Use same command discovery as `CommandClientRegistrationGenerator` to find aggregates
4. Derive target namespace from MSBuild properties (same as existing generators)
5. Emit composite registration class

### Step 2.2: Generator Output

```csharp
// <auto-generated />
using Microsoft.Extensions.DependencyInjection;

using Mississippi.Inlet.Client;
using Mississippi.Reservoir.Blazor.BuiltIn;

using Spring.Client.Features.BankAccountAggregate;

namespace Spring.Client;

[GeneratedCode("InletClientCompositeGenerator", "1.0.0")]
internal static class SpringInletRegistrations
{
    public static IServiceCollection AddSpringInlet(this IServiceCollection services)
    {
        // Aggregate features
        services.AddBankAccountAggregateFeature();
        
        // Built-in Reservoir features
        services.AddReservoirBlazorBuiltIns();
        
        // Inlet client + SignalR
        services.AddInletClient();
        services.AddInletBlazorSignalR(signalR => signalR
            .WithHubPath("/hubs/inlet")
            .ScanProjectionDtos(typeof(SpringInletRegistrations).Assembly));
        
        return services;
    }
}
```

## Phase 3: Sample Update

### Step 3.1: Add Assembly Attribute

**File**: `samples/Spring/Spring.Client/Properties/AssemblyInfo.cs` (create if needed)

```csharp
using Mississippi.Inlet.Generators.Abstractions;

[assembly: GenerateInletClientComposite(AppName = "Spring")]
```

### Step 3.2: Simplify Program.cs

**Before (samples/Spring/Spring.Client/Program.cs)**:
```csharp
builder.Services.AddBankAccountAggregateFeature();
builder.Services.AddEntitySelectionFeature();
builder.Services.AddReservoirBlazorBuiltIns();
builder.Services.AddInletClient();
builder.Services.AddInletBlazorSignalR(signalR => signalR
    .WithHubPath("/hubs/inlet")
    .ScanProjectionDtos(typeof(BankAccountBalanceProjectionDto).Assembly));
```

**After**:
```csharp
builder.Services.AddSpringInlet();
builder.Services.AddEntitySelectionFeature();  // App-specific, stays manual
```

## Phase 4: Testing

### Step 4.1: Add Generator Tests

**File**: `tests/Inlet.Client.Generators.L0Tests/InletClientCompositeGeneratorTests.cs`

Test cases:
1. Generator produces output when assembly attribute present
2. Generated class has correct name (`{AppName}InletRegistrations`)
3. Generated method has correct name (`Add{AppName}Inlet`)
4. Generated code includes all discovered aggregates
5. Generated code includes Reservoir built-ins
6. Generated code includes Inlet client and SignalR setup
7. Custom hub path is respected
8. No output when attribute missing
9. Diagnostic when AppName missing

## Phase 5: Validation

### Step 5.1: Build and Test

```powershell
pwsh ./eng/src/agent-scripts/build-sample-solution.ps1
pwsh ./eng/src/agent-scripts/clean-up-sample-solution.ps1
pwsh ./eng/src/agent-scripts/unit-test-sample-solution.ps1
```

### Step 5.2: Run Spring Sample

```powershell
pwsh ./run-spring.ps1
```

Verify that the application works correctly with the new composite registration.

## Files to Create/Modify

| File | Action | Description |
|------|--------|-------------|
| `src/Inlet.Generators.Abstractions/GenerateInletClientCompositeAttribute.cs` | CREATE | New assembly-level attribute |
| `src/Inlet.Client.Generators/InletClientCompositeGenerator.cs` | CREATE | New source generator |
| `samples/Spring/Spring.Client/Properties/AssemblyInfo.cs` | CREATE | Assembly attribute declaration |
| `samples/Spring/Spring.Client/Program.cs` | MODIFY | Simplify to use generated method |
| `tests/Inlet.Client.Generators.L0Tests/InletClientCompositeGeneratorTests.cs` | CREATE | Unit tests for generator |

## Rollout

- **Additive change**: Existing registrations continue to work
- **Opt-in**: Samples/apps add assembly attribute to enable
- **No migration required**: Existing code unaffected

## Risks & Mitigations

| Risk | Mitigation |
|------|------------|
| No aggregates found | Emit warning diagnostic; still generate Reservoir + Inlet setup |
| Assembly scanning perf | Generator runs incrementally; reuses existing patterns |
| Ordering issues | Aggregate features first, then built-ins, then Inlet (matches manual order) |
