name: PR Labeler

on:
  pull_request_target:
    types: [opened, synchronize, reopened, edited]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  # Label based on changed files (runs on open/sync/reopen)
  label-by-files:
    runs-on: ubuntu-latest
    # Skip on 'edited' since file labels don't change when title changes
    if: github.event.action != 'edited'
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Label PR by changed files
        uses: actions/labeler@v6
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          configuration-path: .github/labeler.yml

  # Label based on PR title semver suffix (runs on all triggers)
  label-by-semver:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Parse title and apply semver labels
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const title = context.payload.pull_request.title;
            const prNumber = context.payload.pull_request.number;

            // Semver label mappings based on +semver: suffix
            // See: .github/instructions/pr-description.instructions.md
            const semverLabels = {
              'breaking': 'semver:breaking',
              'feature': 'semver:feature', 
              'fix': 'semver:fix',
              'skip': 'semver:skip'
            };

            // All possible semver labels (to remove stale ones)
            const allSemverLabels = Object.values(semverLabels);

            // Parse the +semver: suffix from title
            const semverMatch = title.match(/\+semver:\s*(breaking|feature|fix|skip)\s*$/i);
            const detectedType = semverMatch ? semverMatch[1].toLowerCase() : null;
            const labelToAdd = detectedType ? semverLabels[detectedType] : null;

            // Get current labels on the PR
            const { data: currentLabels } = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });
            const currentLabelNames = currentLabels.map(l => l.name);

            // Remove stale semver labels (if title changed)
            for (const label of allSemverLabels) {
              if (currentLabelNames.includes(label) && label !== labelToAdd) {
                console.log(`Removing stale label: ${label}`);
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  name: label
                });
              }
            }

            // Add the detected semver label (if not already present)
            if (labelToAdd && !currentLabelNames.includes(labelToAdd)) {
              console.log(`Adding label: ${labelToAdd}`);
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                labels: [labelToAdd]
              });
            }

            // Log result
            if (labelToAdd) {
              console.log(`PR #${prNumber} labeled with: ${labelToAdd}`);
            } else {
              console.log(`PR #${prNumber} has no +semver: suffix in title`);
            }
