name: ReSharper Cleanup Check

on:
  pull_request:
    branches: [ main, feature/**, topic/** ]
  merge_group:
  push:
    branches: [ main ]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

env:
  DOTSETTINGS_PATH: ${{ github.workspace }}/Directory.DotSettings
  CONFIGURATION: Release

jobs:
  discover-projects:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - id: set-matrix
        shell: pwsh
        run: |
          $eventName = "${{ github.event_name }}"

          # For PRs, try to scope to changed projects; otherwise run all.
          $runAll = $false

          if ($eventName -eq "pull_request") {
            $base = "${{ github.event.pull_request.base.sha }}"
            $head = "${{ github.event.pull_request.head.sha }}"
            $changed = git diff --name-only $base $head

            # If global formatting/settings inputs changed, run everything
            if ($changed | Where-Object {
              $_ -match '(^|/)\.editorconfig$' -or
              $_ -match '\.DotSettings$' -or
              $_ -match '(^|/)Directory\.Build\.(props|targets)$'
            }) {
              $runAll = $true
            }

            if (-not $runAll) {
              # Heuristic: walk up from each changed file to find the nearest csproj
              $projects = New-Object System.Collections.Generic.HashSet[string]
              foreach ($f in $changed) {
                if (-not (Test-Path $f)) { continue }
                $dir = Split-Path $f -Parent
                while ($dir -and $dir -ne "." -and (Test-Path $dir)) {
                  $csproj = Get-ChildItem -Path $dir -Filter *.csproj -File -ErrorAction SilentlyContinue | Select-Object -First 1
                  if ($csproj) {
                    [void]$projects.Add($csproj.FullName)
                    break
                  }
                  $dir = Split-Path $dir -Parent
                }
              }

              if ($projects.Count -gt 0) {
                $projectList = $projects | Sort-Object
              } else {
                $runAll = $true
              }
            }
          } else {
            $runAll = $true
          }

          if ($runAll) {
            $projectList = Get-ChildItem -Path $env:GITHUB_WORKSPACE -Recurse -Filter *.csproj -File |
              Where-Object { $_.FullName -notmatch '[\\/](bin|obj)[\\/]' } |
              ForEach-Object { $_.FullName } |
              Sort-Object
          }

          # Convert absolute paths to workspace-relative paths for cleaner logs
          $rel = $projectList | ForEach-Object {
            $_.Replace($env:GITHUB_WORKSPACE + [IO.Path]::DirectorySeparatorChar, "")
          }

          $matrixObj = @{ project = @($rel) }
          $json = $matrixObj | ConvertTo-Json -Compress
          "matrix=$json" >> $env:GITHUB_OUTPUT

  cleanup:
    needs: discover-projects
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true         # <-- key change for "fail fast"
      max-parallel: 8         # tune to your runner capacity
      matrix: ${{ fromJSON(needs.discover-projects.outputs.matrix) }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-dotnet@v4
        with:
          global-json-file: global.json

      - name: Cache NuGet
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json', '**/packages.*.lock.json') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Cache JetBrains analysis caches
        uses: actions/cache@v4
        with:
          path: ${{ runner.temp }}/.jb-caches
          key: jb-${{ runner.os }}-${{ hashFiles('**/*.csproj', '**/*.editorconfig', '**/*.DotSettings', '**/Directory.Build.props', '**/Directory.Build.targets') }}
          restore-keys: |
            jb-${{ runner.os }}-

      - name: Restore .NET Tools (manifest required)
        shell: pwsh
        run: |
          if (!(Test-Path ".config/dotnet-tools.json")) {
            Write-Host "ERROR: Expected tool manifest at .config/dotnet-tools.json"
            exit 1
          }
          dotnet tool restore

      # JetBrains explicitly warns that without building, CleanupCode may not resolve binary references
      # and may fail to clean up parts of the codebase.
      - name: Build project (for full cleanup fidelity)
        shell: pwsh
        run: |
          dotnet build "${{ matrix.project }}" `
            --configuration "${{ env.CONFIGURATION }}" `
            -p:RunAnalyzers=false

      - name: Run ReSharper Cleanup Code (project)
        shell: pwsh
        run: |
          dotnet tool run jb cleanupcode `
            --profile="Built-in: Full Cleanup" `
            --settings="${{ env.DOTSETTINGS_PATH }}" `
            --caches-home="${{ runner.temp }}/.jb-caches" `
            --no-updates `
            "${{ matrix.project }}" `
            --LogLevel=TRACE

      - name: Check for Uncommitted Changes
        shell: pwsh
        run: |
          $changes = git status --porcelain | Where-Object { $_ -notmatch 'packages.*\.lock\.json$' }
          if ($changes) {
            Write-Host "ERROR: ReSharper cleanup modified files. Diff:"
            git diff --color=always -- . ':!**/packages*.lock.json'
            exit 1
          }