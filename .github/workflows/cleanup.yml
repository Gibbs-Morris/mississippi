name: ReSharper Cleanup Check

on:
  push:
    branches:
      - main
  merge_group:
  pull_request:
    branches:
      - main
      - feature/**
      - topic/**

env:
  DOTSETTINGS_PATH: ${{ github.workspace }}/Directory.DotSettings

jobs:
  cleanup:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ ubuntu-latest, windows-latest ]
        solution: [ mississippi.slnx, samples.slnx ]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: global.json

      - name: Cache GitVersion tools
        uses: actions/cache@v4
        with:
          path: ~/.gitversion
          key: ${{ runner.os }}-gitversion
          restore-keys: ${{ runner.os }}-gitversion

      - name: Cache nugets
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json') }}
          restore-keys: |
            ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json') }}

      - name: Check for dotnet tools manifest
        id: check-tools-manifest
        shell: pwsh
        run: |
          if (Test-Path ".config/dotnet-tools.json") {
            echo "manifest_exists=true" >> $env:GITHUB_OUTPUT
          } else {
            echo "manifest_exists=false" >> $env:GITHUB_OUTPUT
          }

      - name: Restore .NET Tools
        if: steps.check-tools-manifest.outputs.manifest_exists == 'true'
        shell: pwsh
        run: |
          Write-Host "Restoring dotnet tools..."
          dotnet tool restore
        continue-on-error: false

      - name: Install ReSharper Global Tools
        if: steps.check-tools-manifest.outputs.manifest_exists != 'true'
        shell: pwsh
        run: |
          Write-Host "Installing JetBrains.ReSharper.GlobalTools..."
          dotnet tool install -g JetBrains.ReSharper.GlobalTools
        continue-on-error: false

      - name: Generate legacy solution file
        shell: pwsh
        run: |
          $slnxPath = Join-Path "${{ github.workspace }}" "${{ matrix.solution }}"
          $slnPath = $slnxPath -replace '\.slnx$', '.sln'
          Write-Host "Generating $slnPath from $slnxPath ..."
          dotnet tool run slngen "$slnxPath" --solutionfile "$slnPath" --launch false
          Get-Item "$slnPath" | Format-List

      - name: Run ReSharper Cleanup Code
        shell: pwsh
        run: |
          $slnxPath = Join-Path "${{ github.workspace }}" "${{ matrix.solution }}"
          $slnPath = $slnxPath -replace '\.slnx$', '.sln'
          $logPath = Join-Path $env:RUNNER_TEMP ("cleanupcode_{0}_{1}.log" -f "${{ matrix.solution }}", "${{ runner.os }}")
          Write-Host "Running ReSharper Cleanup Code on $slnPath ..."
          dotnet tool run jb cleanupcode --profile="Built-in: Full Cleanup" --settings="${{ env.DOTSETTINGS_PATH }}" --verbosity=TRACE "$slnPath" 2>&1 | Tee-Object -FilePath $logPath
          Write-Host "Cleanup completed. Log: $logPath"
          echo "SLN_PATH=$slnPath" >> $env:GITHUB_ENV
          echo "CLEANUP_LOG=$logPath" >> $env:GITHUB_ENV

      - name: Check for Uncommitted Changes
        shell: pwsh
        run: |
          Write-Host "Checking for modifications after cleanup..."
          $diffPath = Join-Path $env:RUNNER_TEMP ("cleanup_diff_{0}_{1}.patch" -f "${{ matrix.solution }}", "${{ runner.os }}")
          $fileListPath = Join-Path $env:RUNNER_TEMP ("cleanup_changed_files_{0}_{1}.txt" -f "${{ matrix.solution }}", "${{ runner.os }}")
          $changes = git status --porcelain
          $changes | Out-File -FilePath $fileListPath -Encoding UTF8
          echo "DIFF_PATH=$diffPath" >> $env:GITHUB_ENV
          echo "CHANGED_FILES_PATH=$fileListPath" >> $env:GITHUB_ENV
          if ($changes) {
            Write-Host "ERROR: ReSharper cleanup modified files. The following changes are required:"
            git diff --color=always
            git diff > $diffPath
            Write-Host ""
            Write-Host "To resolve this locally run:"
            Write-Host 'dotnet tool run jb cleanupcode --profile="Built-in: Full Cleanup" --settings="${{ env.DOTSETTINGS_PATH }}" "$env:SLN_PATH"'
            exit 1
          } else {
            Write-Host "No modifications detected. Cleanup check passed."
          }

      - name: Upload cleanup artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cleanup-${{ matrix.os }}-${{ matrix.solution }}
          path: |
            ${{ env.CLEANUP_LOG }}
            ${{ env.DIFF_PATH }}
            ${{ env.CHANGED_FILES_PATH }}
          if-no-files-found: ignore
          retention-days: 7
