name: ReSharper Cleanup Check

on:
  push:
    branches:
      - main
  merge_group:
  pull_request:
    branches:
      - main
      - feature/**
      - topic/**

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git line endings
        run: |
          git config core.autocrlf false
          git config core.eol lf
          echo "Git line ending configuration:"
          git config --get core.autocrlf
          git config --get core.eol

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: global.json

      - name: Cache GitVersion tools
        uses: actions/cache@v4
        with:
          path: ~/.gitversion
          key: ${{ runner.os }}-gitversion
          restore-keys: ${{ runner.os }}-gitversion

      - name: Cache nugets
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json') }}
          restore-keys: |
            ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json') }}

      - name: Restore .NET Tools from manifest
        run: |
          set -euo pipefail
          echo "Restoring dotnet tools from .config/dotnet-tools.json..."
          dotnet tool restore

      - name: Run cleanup on both solutions
        shell: pwsh
        run: |
          ./eng/cleanup.ps1 -Solutions @("mississippi.slnx","samples.slnx")

      - name: Check for uncommitted changes
        run: |
          set -euo pipefail
          echo "Checking for modifications after cleanup..."
          CHANGES=$(git status --porcelain=v1 -uno)
          if [ -n "$CHANGES" ]; then
            echo "ERROR: ReSharper cleanup modified files. The following changes are required:"
            echo ""
            echo "Modified files:"
            echo "$CHANGES"
            echo ""
            echo "Diff:"
            git diff --color=always
            echo ""
            echo "To resolve this locally, run:"
            echo "  pwsh ./eng/cleanup.ps1"
            echo ""
            exit 1
          else
            echo "âœ“ No modifications detected. Cleanup check passed."
          fi

      - name: Assert idempotency
        shell: pwsh
        run: |
          Write-Host "Running cleanup a second time to verify idempotency..." -ForegroundColor Cyan
          ./eng/cleanup.ps1 -Check