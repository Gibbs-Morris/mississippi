name: ReSharper Cleanup Check

on:
  push:
    branches:
      - main
  merge_group:
  pull_request:
    branches:
      - main
      - feature/**
      - topic/**

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git line endings
        run: |
          set -euo pipefail
          echo "Configuring Git to enforce LF line endings..."
          git config core.autocrlf false
          git config core.eol lf
          echo "Git configuration:"
          git config --get core.autocrlf
          git config --get core.eol

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: global.json

      - name: Cache GitVersion tools
        uses: actions/cache@v4
        with:
          path: ~/.gitversion
          key: ${{ runner.os }}-gitversion
          restore-keys: ${{ runner.os }}-gitversion

      - name: Cache nugets
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json') }}
          restore-keys: |
            ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json') }}

      - name: Restore .NET Tools
        run: |
          set -euo pipefail
          echo "Restoring dotnet tools from .config/dotnet-tools.json..."
          dotnet tool restore
        continue-on-error: false

      - name: Run ReSharper Cleanup (First Pass)
        run: |
          set -euo pipefail
          echo "Running unified cleanup script for all solutions..."
          pwsh ./clean-up.ps1 -Solutions @("mississippi.slnx","samples.slnx")

      - name: Check for Uncommitted Changes
        run: |
          set -euo pipefail
          echo "Checking for modifications after cleanup..."
          CHANGES=$(git status --porcelain=v1 -uno)
          if [ -n "$CHANGES" ]; then
            echo "ERROR: ReSharper cleanup modified files. The following changes are required:"
            echo ""
            git diff --color=always
            echo ""
            echo "To resolve this locally, run:"
            echo "  pwsh ./clean-up.ps1"
            echo ""
            echo "Or to check before pushing:"
            echo "  pwsh ./clean-up.ps1 -Check"
            exit 1
          else
            echo "No modifications detected. Cleanup check passed."
          fi

      - name: Run ReSharper Cleanup (Second Pass - Idempotency Check)
        run: |
          set -euo pipefail
          echo "Running cleanup again to verify idempotency..."
          pwsh ./clean-up.ps1 -Solutions @("mississippi.slnx","samples.slnx")

      - name: Verify Idempotency
        run: |
          set -euo pipefail
          echo "Verifying no changes after second cleanup pass..."
          CHANGES=$(git status --porcelain=v1 -uno)
          if [ -n "$CHANGES" ]; then
            echo "ERROR: Cleanup is not idempotent! Second pass produced changes:"
            echo ""
            git diff --color=always
            exit 1
          else
            echo "SUCCESS: Cleanup is idempotent. No changes on second pass."
          fi