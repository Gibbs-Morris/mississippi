name: ReSharper Cleanup Check

on:
  push:
    branches:
      - main
  merge_group:
  pull_request:
    branches:
      - main
      - feature/**
      - topic/**

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

env:
  DOTSETTINGS_PATH: ${{ github.workspace }}/repo/Directory.DotSettings
  CONFIGURATION: Release
  REPO_PATH: repo

jobs:
  cleanup:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ ubuntu-latest ]
        solution: [ mississippi.slnx, samples.slnx ]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          path: ${{ env.REPO_PATH }}

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: ${{ env.REPO_PATH }}/global.json

      - name: Cache GitVersion tools
        uses: actions/cache@v4
        with:
          path: ~/.gitversion
          key: ${{ runner.os }}-gitversion
          restore-keys: ${{ runner.os }}-gitversion

      - name: Cache nugets
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json') }}
          restore-keys: |
            ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json') }}

      - name: Cache JetBrains caches
        uses: actions/cache@v4
        with:
          path: ${{ env.REPO_PATH }}/.jb-caches
          key: jb-${{ runner.os }}-${{ hashFiles('repo/**/*.sln', 'repo/**/*.slnx', 'repo/**/*.csproj', 'repo/**/.editorconfig', 'repo/**/*.DotSettings') }}
          restore-keys: |
            jb-${{ runner.os }}-

      - name: Install GitVersion
        uses: gittools/actions/gitversion/setup@v3.2.1
        with:
          versionSpec: "6.0.5"

      - name: Determine Version
        id: gitversion
        uses: gittools/actions/gitversion/execute@v3.2.1
        with:
          useConfigFile: true
          targetPath: ${{ env.REPO_PATH }}

      - name: Restore dotnet packages
        run: |
          dotnet restore ${{ github.workspace }}/${{ env.REPO_PATH }}/${{ matrix.solution }}

      - name: Build dotnet projects
        run: |
          dotnet build ${{ github.workspace }}/${{ env.REPO_PATH }}/${{ matrix.solution }} --configuration ${{ env.CONFIGURATION }} --no-restore --no-incremental -warnaserror -p:Version=${{ steps.gitversion.outputs.SemVer }}

      - name: Check for dotnet tools manifest
        id: check-tools-manifest
        shell: pwsh
        working-directory: ${{ env.REPO_PATH }}
        run: |
          if (Test-Path ".config/dotnet-tools.json") {
            echo "manifest_exists=true" >> $env:GITHUB_OUTPUT
          } else {
            echo "manifest_exists=false" >> $env:GITHUB_OUTPUT
          }

      - name: Restore .NET Tools
        if: steps.check-tools-manifest.outputs.manifest_exists == 'true'
        shell: pwsh
        working-directory: ${{ env.REPO_PATH }}
        run: |
          Write-Host "Restoring dotnet tools..."
          dotnet tool restore
        continue-on-error: false

      - name: Install ReSharper Global Tools
        if: steps.check-tools-manifest.outputs.manifest_exists != 'true'
        shell: pwsh
        working-directory: ${{ env.REPO_PATH }}
        run: |
          Write-Host "Installing JetBrains.ReSharper.GlobalTools..."
          dotnet tool install -g JetBrains.ReSharper.GlobalTools
        continue-on-error: false

      - name: Generate legacy solution file
        shell: pwsh
        working-directory: ${{ env.REPO_PATH }}
        run: |
          $slnxPath = Join-Path "${{ github.workspace }}/${{ env.REPO_PATH }}" "${{ matrix.solution }}"
          $slnPath = $slnxPath -replace '\.slnx$', '.sln'
          Write-Host "Generating $slnPath from $slnxPath ..."
          dotnet tool run slngen "$slnxPath" --solutionfile "$slnPath" --launch false
          Get-Item "$slnPath" | Format-List

      - name: Run ReSharper Cleanup Code
        shell: pwsh
        working-directory: ${{ env.REPO_PATH }}
        run: |
          $slnxPath = Join-Path "${{ github.workspace }}/${{ env.REPO_PATH }}" "${{ matrix.solution }}"
          $slnPath = $slnxPath -replace '\.slnx$', '.sln'
          Write-Host "Running ReSharper Cleanup Code on $slnPath ..."
          dotnet tool run jb cleanupcode --profile="Built-in: Full Cleanup" --settings="${{ env.DOTSETTINGS_PATH }}" "$slnPath" --caches-home=.jb-caches --no-updates --LogLevel=TRACE
          Write-Host "Cleanup completed."
          echo "SLN_PATH=$slnPath" >> $env:GITHUB_ENV
          $slnFileName = Split-Path -Path $slnPath -Leaf
          echo "SLN_FILE_NAME=$slnFileName" >> $env:GITHUB_ENV

      - name: Check for Uncommitted Changes
        shell: pwsh
        working-directory: ${{ env.REPO_PATH }}
        run: |
          Write-Host "Checking for modifications after cleanup..."
          # Exclude packages.lock.json files as Aspire dependencies may differ between platforms
          $changes = git status --porcelain | Where-Object { $_ -notmatch 'packages\.lock\.json$' }
          if ($changes) {
            Write-Host "ERROR: ReSharper cleanup modified files. The following changes are required:"
            git diff --color=always -- . ':!**/packages.lock.json'
            Write-Host ""
            Write-Host "To resolve this locally run:"
            $slnFileName = $env:SLN_FILE_NAME
            if (-not $slnFileName -and $env:SLN_PATH) {
              $slnFileName = Split-Path -Path $env:SLN_PATH -Leaf
            }

            if ([string]::IsNullOrWhiteSpace($slnFileName)) {
              Write-Host "Unable to determine the solution file name for local cleanup. Check workflow logs for details."
            }
            else {
              $localCommand = "dotnet tool run jb cleanupcode --profile=`"Built-in: Full Cleanup`" --settings=`"Directory.DotSettings`" $slnFileName"
              Write-Host "Run the following from the repository root:"
              Write-Host $localCommand
            }
            exit 1
          } else {
            Write-Host "No modifications detected. Cleanup check passed."
          }