@using System.ComponentModel.DataAnnotations
@using Cascade.Server.Components.Services
@inject IChatService ChatService

<div class="modal-backdrop" @onclick="Close">
    <div class="modal-content" @onclick:stopPropagation="true">
        <h4>Create Channel</h4>

        <EditForm Model="model" OnValidSubmit="HandleSubmit" FormName="createChannel">
            <DataAnnotationsValidator/>

            <div class="form-group mb-3">
                <label for="channelName">Channel Name</label>
                <InputText id="channelName" @bind-Value="model.Name" class="form-control" placeholder="e.g., general"/>
                <ValidationMessage For="() => model.Name" class="text-danger"/>
            </div>

            <div class="form-group mb-3">
                <label for="channelDescription">Description (optional)</label>
                <InputTextArea id="channelDescription" @bind-Value="model.Description" class="form-control" rows="3"/>
            </div>

            @if (error is not null)
            {
                <div class="alert alert-danger">@error</div>
            }

            <div class="modal-actions d-flex gap-2 justify-content-end">
                <button type="button" class="btn btn-secondary" @onclick="Close" disabled="@isLoading">Cancel</button>
                <button type="submit" class="btn btn-primary" disabled="@isLoading">
                    @if (isLoading)
                    {
                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                    }
                    Create
                </button>
            </div>
        </EditForm>
    </div>
</div>

@code {

    /// <summary>
    ///     Gets or sets the callback when a channel is created.
    /// </summary>
    [Parameter]
    public EventCallback<string> OnCreated { get; set; }

    /// <summary>
    ///     Gets or sets the callback when the modal is closed.
    /// </summary>
    [Parameter]
    public EventCallback OnClose { get; set; }

    private readonly CreateChannelModel model = new();

    private bool isLoading;

    private string? error;

    private async Task HandleSubmit()
    {
        isLoading = true;
        error = null;
        try
        {
            string channelId = await ChatService.CreateChannelAsync(model.Name, model.Description);
            await OnCreated.InvokeAsync(channelId);
        }
        catch (ChatOperationException ex)
        {
            error = ex.Message;
        }
#pragma warning disable CA1031 // Catch general exception for UI error display
        catch (Exception ex)
#pragma warning restore CA1031
        {
            error = $"An unexpected error occurred: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task Close() => await OnClose.InvokeAsync();

    private sealed class CreateChannelModel
    {
        [Required(ErrorMessage = "Channel name is required")]
        [StringLength(50, MinimumLength = 2, ErrorMessage = "Channel name must be between 2 and 50 characters")]
        public string Name { get; set; } = string.Empty;

        [StringLength(200, ErrorMessage = "Description cannot exceed 200 characters")]
        public string? Description { get; set; }
    }

}