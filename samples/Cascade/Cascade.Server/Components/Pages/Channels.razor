@page "/channels"
@page "/channels/{ChannelId}"
@using Cascade.Server.Components.Organisms
@using Cascade.Server.Components.Services
@using Cascade.Server.Components.Shared

@inject UserSession UserSession
@inject NavigationManager Navigation

<PageTitle>Cascade Chat - Channels</PageTitle>

@if (!UserSession.IsAuthenticated)
{
    <div class="container mt-5">
        <div class="alert alert-warning">
            <h4>Not Logged In</h4>
            <p>You need to log in to access channels.</p>
            <a href="/login" class="btn btn-primary">Go to Login</a>
        </div>
    </div>
}
else
{
    <div class="chat-container d-flex">
        <ChannelList SelectedChannelId="@ChannelId" OnChannelSelected="HandleChannelSelected"/>

        <div class="channel-content flex-grow-1">
            @if (string.IsNullOrEmpty(ChannelId))
            {
                <div class="no-channel-selected">
                    <h2>Welcome, @UserSession.DisplayName!</h2>
                    <p>Select a channel from the sidebar or create a new one to get started.</p>
                </div>
            }
            else
            {
                <ChannelView
                    ChannelId="@ChannelId"
                    ChannelName="@GetChannelDisplayName(ChannelId)"/>
            }
        </div>
    </div>
}

@code {

    /// <summary>
    ///     Gets or sets the selected channel ID from the route.
    /// </summary>
    [Parameter]
    public string? ChannelId { get; set; }

    /// <inheritdoc />
    protected override void OnInitialized()
    {
        if (!UserSession.IsAuthenticated)
        {
            Navigation.NavigateTo("/login");
        }
    }

    private void HandleChannelSelected(
        string channelId
    )
    {
        Navigation.NavigateTo($"/channels/{channelId}");
    }

    private static string GetChannelDisplayName(
        string channelId
    )
    {
        // Extract a readable name from the channel ID
        // Format is typically: channel-NAME-TIMESTAMP
        if (channelId.StartsWith("channel-", StringComparison.OrdinalIgnoreCase))
        {
            string[] parts = channelId.Substring(8).Split('-');
            if (parts.Length >= 1)
            {
                return parts[0].ToLowerInvariant();
            }
        }

        return channelId;
    }

}