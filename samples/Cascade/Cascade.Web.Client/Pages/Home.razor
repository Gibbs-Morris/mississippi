@page "/"
@inject HttpClient Http
@inject IMessageService MessageService

<h1>Cascade Web</h1>

<section>
    <h2>API Connectivity</h2>
    <p>Status: @apiStatus</p>
    <button @onclick="CallApiAsync">Call API</button>
    @if (!string.IsNullOrEmpty(echoResponse))
    {
        <p>Echo Response: @echoResponse</p>
    }
</section>

<section>
    <h2>SignalR Messaging</h2>
    <p>Connection: @connectionStatus</p>
    <div>
        <input @bind="messageInput" placeholder="Enter message" />
        <button @onclick="SendMessageAsync" disabled="@(!isConnected)">Send</button>
    </div>
    <h3>Messages</h3>
    <ul>
        @foreach (string message in messages)
        {
            <li>@message</li>
        }
    </ul>
</section>

<section>
    <h2>Storage Operations</h2>
    <h3>Cosmos DB</h3>
    <button @onclick="WriteToCosmosAsync">Write to Cosmos</button>
    <button @onclick="ReadFromCosmosAsync">Read from Cosmos</button>
    <p>Cosmos Result: @cosmosResult</p>

    <h3>Blob Storage</h3>
    <button @onclick="WriteToBlobAsync">Write to Blob</button>
    <button @onclick="ReadFromBlobAsync">Read from Blob</button>
    <p>Blob Result: @blobResult</p>
</section>

@code {
    private string apiStatus = "Not checked";
    private string echoResponse = string.Empty;
    private string connectionStatus = "Disconnected";
    private string messageInput = string.Empty;
    private string cosmosResult = string.Empty;
    private string blobResult = string.Empty;
    private readonly List<string> messages = [];
    private bool isConnected;

    protected override async Task OnInitializedAsync()
    {
        MessageService.MessageReceived += HandleMessageReceived;
        await ConnectToSignalRAsync();
    }

    private async Task CallApiAsync()
    {
        try
        {
            HealthResponse? health = await Http.GetFromJsonAsync<HealthResponse>("api/health");
            apiStatus = health?.Status ?? "Unknown";

            EchoResponse? echo = await Http.GetFromJsonAsync<EchoResponse>("api/echo?message=Hello");
            echoResponse = echo?.Message ?? "No response";
        }
        catch (Exception ex)
        {
            apiStatus = $"Error: {ex.Message}";
        }
    }

    private async Task ConnectToSignalRAsync()
    {
        try
        {
            await MessageService.StartAsync();
            isConnected = true;
            connectionStatus = "Connected";
            StateHasChanged();
        }
        catch (Exception ex)
        {
            connectionStatus = $"Error: {ex.Message}";
        }
    }

    private async Task SendMessageAsync()
    {
        if (!string.IsNullOrWhiteSpace(messageInput))
        {
            await MessageService.SendMessageAsync(messageInput);
            messageInput = string.Empty;
        }
    }

    private void HandleMessageReceived(object? sender, MessageReceivedEventArgs e)
    {
        messages.Add(e.Message);
        InvokeAsync(StateHasChanged);
    }

    private async Task WriteToCosmosAsync()
    {
        try
        {
            HttpResponseMessage response = await Http.PostAsJsonAsync(
                "api/cosmos",
                new CosmosItem { Id = Guid.NewGuid().ToString(), Data = $"Test data at {DateTime.UtcNow:O}" });
            cosmosResult = response.IsSuccessStatusCode ? "Written successfully" : $"Error: {response.StatusCode}";
        }
        catch (Exception ex)
        {
            cosmosResult = $"Error: {ex.Message}";
        }
    }

    private async Task ReadFromCosmosAsync()
    {
        try
        {
            CosmosItem[]? items = await Http.GetFromJsonAsync<CosmosItem[]>("api/cosmos");
            cosmosResult = items is { Length: > 0 }
                ? $"Found {items.Length} item(s): {items[0].Data}"
                : "No items found";
        }
        catch (Exception ex)
        {
            cosmosResult = $"Error: {ex.Message}";
        }
    }

    private async Task WriteToBlobAsync()
    {
        try
        {
            HttpResponseMessage response = await Http.PostAsJsonAsync(
                "api/blob",
                new BlobItem { Name = "test-blob", Content = $"Blob content at {DateTime.UtcNow:O}" });
            blobResult = response.IsSuccessStatusCode ? "Written successfully" : $"Error: {response.StatusCode}";
        }
        catch (Exception ex)
        {
            blobResult = $"Error: {ex.Message}";
        }
    }

    private async Task ReadFromBlobAsync()
    {
        try
        {
            BlobItem? item = await Http.GetFromJsonAsync<BlobItem>("api/blob/test-blob");
            blobResult = item is not null ? $"Content: {item.Content}" : "Blob not found";
        }
        catch (Exception ex)
        {
            blobResult = $"Error: {ex.Message}";
        }
    }
}
