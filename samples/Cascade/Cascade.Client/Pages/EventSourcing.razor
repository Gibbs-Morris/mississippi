@page "/event-sourcing"
@using Mississippi.Inlet.Abstractions
@using Mississippi.Inlet.Abstractions.Actions
@inherits Mississippi.Reservoir.Blazor.StoreComponent
@inject IInletStore InletStore
@inject HttpClient Http

<h1>Event Sourcing Demo</h1>
<p>Demonstrates: Blazor Client ‚Üí SignalR ‚Üí Orleans Aggregate/Projection Grains ‚Üí Cosmos DB</p>
<p><strong>Real-time updates via Inlet:</strong> Open this page in multiple browser tabs and watch messages appear in real-time!</p>

<section>
    <h2>Conversation</h2>
    <div style="display: flex; gap: 1rem; align-items: center; margin-bottom: 1rem;">
        <label>Conversation ID:</label>
        <input @bind="conversationId" placeholder="Enter conversation ID" style="width: 250px;"/>
    </div>
    <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
        <button @onclick="JoinConversationAsync" disabled="@(string.IsNullOrWhiteSpace(conversationId) || isJoined)">
            üì° Join Conversation
        </button>
        <button @onclick="StartConversationAsync" disabled="@(string.IsNullOrWhiteSpace(conversationId))">
            ‚ûï Start New Conversation
        </button>
        @if (isJoined)
        {
            <button @onclick="LeaveConversation" style="background-color: #dc3545; color: white;">
                üö™ Leave
            </button>
        }
    </div>
    <p>
        <strong>Status:</strong>
        @if (isJoined)
        {
            <span style="color: green;">‚úÖ Subscribed to "@currentSubscription"</span>
        }
        else
        {
            <span style="color: gray;">‚ö™ Not subscribed</span>
        }
    </p>
    @if (!string.IsNullOrEmpty(statusMessage))
    {
        <p>@statusMessage</p>
    }
</section>

<section>
    <h2>Send Message</h2>
    @if (!isJoined)
    {
        <p style="color: gray;">
            <em>Join a conversation first to send messages.</em>
        </p>
    }
    else
    {
        <div style="display: flex; gap: 1rem; align-items: center; margin-bottom: 0.5rem;">
            <label>Your Name:</label>
            <input @bind="senderName" placeholder="Enter your name" style="width: 150px;"/>
        </div>
        <div style="display: flex; gap: 1rem; align-items: center; margin-bottom: 0.5rem;">
            <label style="width: 85px;">Message:</label>
            <input @bind="messageContent" placeholder="Enter message" @onkeypress="OnMessageKeyPress" style="flex: 1; max-width: 400px;"/>
            <button @onclick="SendMessageAsync"
                    disabled="@(string.IsNullOrWhiteSpace(messageContent) || string.IsNullOrWhiteSpace(senderName))">
                Send
            </button>
        </div>
        @if (!string.IsNullOrEmpty(sendResult))
        {
            <p>@sendResult</p>
        }
    }
</section>

<section>
    <h2>Messages (Real-time Projection)</h2>
    @if (!isJoined)
    {
        <p style="color: gray;">
            <em>Join a conversation to see messages.</em>
        </p>
    }
    else if (InletStore.IsProjectionLoading<ConversationMessagesResponse>(currentSubscription!))
    {
        <p>‚è≥ Loading projection...</p>
    }
    else if (InletStore.GetProjectionError<ConversationMessagesResponse>(currentSubscription!) is { } error)
    {
        <p>‚ùå Error: @error.Message</p>
        <button @onclick="RefreshProjection">Retry</button>
    }
    else if (projection is { Messages.Count: > 0 })
    {
        <p>‚úÖ Receiving updates - Total Messages: @projection.MessageCount</p>
        <table>
            <thead>
            <tr>
                <th>ID</th>
                <th>Sender</th>
                <th>Content</th>
                <th>Sent At</th>
                <th>Status</th>
            </tr>
            </thead>
            <tbody>
            @foreach (ConversationMessageItem message in projection.Messages)
            {
                <tr style="@(message.IsDeleted ? "text-decoration: line-through; color: gray;" : "")">
                    <td>@message.MessageId[..12]...</td>
                    <td>@message.SentBy</td>
                    <td>@message.Content</td>
                    <td>@message.SentAt.ToString("HH:mm:ss")</td>
                    <td>
                        @if (message.IsDeleted)
                        {
                            <span>Deleted</span>
                        }
                        else if (message.EditedAt.HasValue)
                        {
                            <span>Edited @message.EditedAt.Value.ToString("HH:mm:ss")</span>
                        }
                        else
                        {
                            <span>‚úì</span>
                        }
                    </td>
                </tr>
            }
            </tbody>
        </table>
    }
    else if (projection is not null)
    {
        <p>‚úÖ Subscribed - <em>No messages yet. Send one above!</em></p>
    }
    else
    {
        <p>üì° Waiting for projection data...</p>
    }
</section>

@code {

    private string conversationId = "demo-conversation";

    private string senderName = "Demo User";

    private string messageContent = string.Empty;

    private string statusMessage = string.Empty;

    private string sendResult = string.Empty;

    private string? currentSubscription;

    private bool isJoined => !string.IsNullOrWhiteSpace(currentSubscription);

    private ConversationMessagesResponse? projection => isJoined ? InletStore.GetProjection<ConversationMessagesResponse>(currentSubscription!) : null;

    private Task JoinConversationAsync()
    {
        if (string.IsNullOrWhiteSpace(conversationId))
        {
            return Task.CompletedTask;
        }

        // Unsubscribe from previous if different
        if (!string.IsNullOrWhiteSpace(currentSubscription) && (currentSubscription != conversationId))
        {
            Dispatch(new UnsubscribeFromProjectionAction<ConversationMessagesResponse>(currentSubscription));
        }

        // Subscribe to the new conversation's projection
        currentSubscription = conversationId;
        Dispatch(new SubscribeToProjectionAction<ConversationMessagesResponse>(currentSubscription));
        statusMessage = $"üì° Joined conversation '{conversationId}' - listening for real-time updates...";
        return Task.CompletedTask;
    }

    private void LeaveConversation()
    {
        if (!string.IsNullOrWhiteSpace(currentSubscription))
        {
            Dispatch(new UnsubscribeFromProjectionAction<ConversationMessagesResponse>(currentSubscription));
            statusMessage = $"Left conversation '{currentSubscription}'";
            currentSubscription = null;
        }
    }

    private void RefreshProjection()
    {
        if (isJoined)
        {
            Dispatch(new RefreshProjectionAction<ConversationMessagesResponse>(currentSubscription!));
        }
    }

    private async Task StartConversationAsync()
    {
        statusMessage = "Starting conversation...";
        try
        {
            HttpResponseMessage response = await Http.PostAsync($"/api/conversations/{Uri.EscapeDataString(conversationId)}/start", null);
            string content = await response.Content.ReadAsStringAsync();
            if (response.IsSuccessStatusCode)
            {
                statusMessage = $"‚úì Conversation '{conversationId}' started successfully!";

                // Auto-join after starting
                await JoinConversationAsync();
            }
            else
            {
                statusMessage = $"‚úó Failed to start: {content}";
            }
        }
        catch (Exception ex)
        {
            statusMessage = $"‚úó Exception: {ex.Message}";
        }
    }

    private async Task OnMessageKeyPress(
        KeyboardEventArgs e
    )
    {
        if (e.Key == "Enter")
        {
            await SendMessageAsync();
        }
    }

    private async Task SendMessageAsync()
    {
        if (!isJoined)
        {
            return;
        }

        sendResult = "Sending...";
        try
        {
            SendMessageRequest request = new()
            {
                Content = messageContent,
                SentBy = senderName,
            };
            HttpResponseMessage response = await Http.PostAsJsonAsync($"/api/conversations/{Uri.EscapeDataString(currentSubscription!)}/messages", request);
            string content = await response.Content.ReadAsStringAsync();
            sendResult = response.IsSuccessStatusCode ? "‚úì Sent!" : $"‚úó Error: {content}";

            // Clear message input - projection will auto-update via SignalR
            if (response.IsSuccessStatusCode)
            {
                messageContent = string.Empty;
                // Clear the send result after a moment
                _ = Task.Delay(2000)
                    .ContinueWith(
                        _ =>
                        {
                            sendResult = string.Empty;
                            InvokeAsync(StateHasChanged);
                        },
                        TaskScheduler.Default);
            }
        }
        catch (Exception ex)
        {
            sendResult = $"‚úó Exception: {ex.Message}";
        }
    }

}