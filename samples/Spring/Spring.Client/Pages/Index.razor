@page "/"
@using Spring.Client.Features.BankAccountLedger.Dtos
@inherits InletComponent

<main>
    <header>
        <h1>Bank Account Operations</h1>
        <p>Mississippi Event Sourcing Demo</p>
        <button type="button"
                aria-label="Connection status"
                aria-haspopup="dialog"
                aria-expanded="@isConnectionModalOpen"
                @onclick="ToggleConnectionModal">
            @ConnectionState.Status
        </button>
    </header>

    @if (string.IsNullOrEmpty(SelectedEntityId))
    {
        <section>
            <h2>Select Account</h2>
            <p>Enter an account identifier to begin banking operations.</p>
            <div>
                <label for="account-id-input">Account Identifier</label>
                <input id="account-id-input"
                       type="text"
                       @bind="accountIdInput"
                       placeholder="Enter account ID"/>
            </div>
            <button type="button" @onclick="SetEntityId">Continue</button>
        </section>
    }
    else
    {
        <div>
            <span>Account: @SelectedEntityId</span>
            <button type="button" @onclick="ClearEntity">Switch</button>
        </div>
        <section>
            <h2>Open Account</h2>
            <fieldset disabled="@(IsExecutingOrLoading || IsAccountOpen)">
                <legend>Open Account</legend>
                @if (IsAccountOpen)
                {
                    <p>
                        <em>Account is already open.</em>
                    </p>
                }
                else
                {
                    <div>
                        <label for="holder-name-input">Holder Name</label>
                        <input id="holder-name-input"
                               type="text"
                               @bind="holderName"
                               placeholder="Account holder name"/>
                    </div>
                    <div>
                        <label for="initial-deposit-input">Initial Deposit (£)</label>
                        <input id="initial-deposit-input"
                               type="number"
                               @bind="initialDeposit"
                               placeholder="0.00"
                               step="0.01"
                               min="0"/>
                    </div>
                    <button type="button" @onclick="OpenAccount" disabled="@IsExecutingOrLoading">
                        Open Account
                    </button>
                }
            </fieldset>
        </section>
        <section>
            <h2>Deposit (£)</h2>
            <fieldset disabled="@(IsExecutingOrLoading || !IsAccountOpen)">
                <legend>Deposit Funds (GBP)</legend>
                <div>
                    <label for="deposit-amount-input">Amount (£)</label>
                    <input id="deposit-amount-input"
                           type="number"
                           @bind="depositAmount"
                           placeholder="0.00"
                           step="0.01"
                           min="0"/>
                </div>
                <button type="button" @onclick="Deposit" disabled="@(IsExecutingOrLoading || !IsAccountOpen)">Deposit £</button>
                <div>
                    <span>Quick:</span>
                    <button type="button" @onclick="DepositSingle100" disabled="@(IsExecutingOrLoading || !IsAccountOpen)">+£100</button>
                    <button type="button" @onclick="DepositBurst20" disabled="@(IsExecutingOrLoading || !IsAccountOpen)">20×£5</button>
                    <button type="button" @onclick="DepositBurst200" disabled="@(IsExecutingOrLoading || !IsAccountOpen)">200×£10</button>
                </div>
            </fieldset>
        </section>
        <section>
            <h2>Withdraw</h2>
            <fieldset disabled="@(IsExecutingOrLoading || !IsAccountOpen)">
                <legend>Withdraw Funds</legend>
                <div>
                    <label for="withdraw-amount-input">Amount (£)</label>
                    <input id="withdraw-amount-input"
                           type="number"
                           @bind="withdrawAmount"
                           placeholder="0.00"
                           step="0.01"
                           min="0"/>
                </div>
                <button type="button" @onclick="Withdraw" disabled="@(IsExecutingOrLoading || !IsAccountOpen)">Withdraw</button>
                <div>
                    <span>Quick:</span>
                    <button type="button" @onclick="WithdrawSingle100" disabled="@(IsExecutingOrLoading || !IsAccountOpen)">-£100</button>
                    <button type="button" @onclick="WithdrawBurst20" disabled="@(IsExecutingOrLoading || !IsAccountOpen)">20×£5</button>
                    <button type="button" @onclick="WithdrawBurst200" disabled="@(IsExecutingOrLoading || !IsAccountOpen)">200×£10</button>
                </div>
            </fieldset>
        </section>
        <section>
            <h2>Account Status</h2>
            @if (BalanceProjection is not null)
            {
                <div>
                    <div>
                        <span>Balance:</span>
                        <span>@BalanceProjection.Balance.ToString("C")</span>
                    </div>
                    <div>
                        <span>Holder:</span>
                        <span>@BalanceProjection.HolderName</span>
                    </div>
                    <div>
                        <span>Status:</span>
                        <span>@(BalanceProjection.IsOpen ? "Open" : "Closed")</span>
                    </div>
                </div>
            }
            else
            {
                <div>
                    <h3>Awaiting Data</h3>
                    <p>Open an account to begin viewing real-time projection data.</p>
                </div>
            }

            @if (!string.IsNullOrEmpty(ErrorMessage))
            {
                <div role="alert">
                    <strong>Error:</strong> @ErrorMessage
                </div>
            }

            @if (AggregateState.LastCommandSucceeded is true)
            {
                <div role="status">
                    Command executed successfully.
                </div>
            }
        </section>
        <section>
            <h2>Transaction Ledger</h2>
            @if (LedgerProjection?.Entries.Length > 0)
            {
                <table>
                    <thead>
                    <tr>
                        <th>Type</th>
                        <th>Amount (£)</th>
                    </tr>
                    </thead>
                    <tbody>
                    @foreach (LedgerEntryDto entry in LedgerProjection.Entries)
                    {
                        <tr>
                            <td>@entry.EntryType</td>
                            <td>@entry.Amount</td>
                        </tr>
                    }
                    </tbody>
                </table>
            }
            else
            {
                <p>No transactions yet.</p>
            }
        </section>
    }

    @if (isConnectionModalOpen)
    {
        <dialog open>
            <header>
                <h2>SignalR Connection</h2>
                <button type="button" @onclick="CloseConnectionModal">Close</button>
            </header>
            <div>
                <div>
                    <span>Status:</span> <span>@ConnectionState.Status</span>
                </div>
                <div>
                    <span>Connection ID:</span> <span>@(ConnectionState.ConnectionId ?? "—")</span>
                </div>
                <div>
                    <span>Reconnect Attempts:</span> <span>@ConnectionState.ReconnectAttemptCount</span>
                </div>
                <div>
                    <span>Last Connected:</span> <span>@FormatTimestamp(ConnectionState.LastConnectedAt)</span>
                </div>
                <div>
                    <span>Last Disconnected:</span> <span>@FormatTimestamp(ConnectionState.LastDisconnectedAt)</span>
                </div>
                <div>
                    <span>Last Message:</span> <span>@FormatTimestamp(ConnectionState.LastMessageReceivedAt)</span>
                </div>
                @if (ConnectionState.LastError is not null)
                {
                    <div>
                        <span>Last Error:</span> <span>@ConnectionState.LastError</span>
                    </div>
                }
            </div>
        </dialog>
    }

    @if (IsDisconnected)
    {
        <dialog open>
            <header>
                <h2>Connection Lost</h2>
            </header>
            <div>
                <p>@ConnectionState.Status</p>
                @if (ConnectionState.ReconnectAttemptCount > 0)
                {
                    <p>Reconnect Attempt @ConnectionState.ReconnectAttemptCount</p>
                }
                @if (ConnectionState.LastError is not null)
                {
                    <p>@ConnectionState.LastError</p>
                }
                <button type="button" @onclick="RequestReconnect">Reconnect</button>
            </div>
        </dialog>
    }
</main>