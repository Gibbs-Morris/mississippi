@page "/"
@inherits InletComponent

<h1>Bank Account Demo</h1>

<div>
    <label>Account ID:</label>
    <input @bind="accountIdInput" placeholder="Enter account ID"/>
    <button @onclick="SetEntityId">Set Account</button>
</div>

@if (!string.IsNullOrEmpty(AggregateState.EntityId))
{
    <h2>Account: @AggregateState.EntityId</h2>
    <div>
        <h3>Open Account</h3>
        <input @bind="holderName" placeholder="Holder Name"/>
        <input type="number" @bind="initialDeposit" placeholder="Initial Deposit"/>
        <button @onclick="OpenAccount" disabled="@IsExecutingOrLoading">Open Account</button>
    </div>
    <div>
        <h3>Deposit Funds</h3>
        <input type="number" @bind="depositAmount"/>
        <button @onclick="Deposit" disabled="@IsExecutingOrLoading">Deposit</button>
    </div>
    <div>
        <h3>Withdraw Funds</h3>
        <input type="number" @bind="withdrawAmount"/>
        <button @onclick="Withdraw" disabled="@IsExecutingOrLoading">Withdraw</button>
    </div>
    @if (IsExecutingOrLoading)
    {
        <p>Loading...</p>
    }

    @if (BalanceProjection is not null)
    {
        <div>
            <p>
                <strong>Balance:</strong> @BalanceProjection.Balance.ToString("C")
            </p>
            <p>
                <strong>Holder:</strong> @BalanceProjection.HolderName
            </p>
            <p>
                <strong>Status:</strong> @(BalanceProjection.IsOpen ? "Open" : "Closed")
            </p>
        </div>
    }

    @if (!string.IsNullOrEmpty(ErrorMessage))
    {
        <p style="color: red;">@ErrorMessage</p>
    }

    @if (AggregateState.LastCommandSucceeded == true)
    {
        <p style="color: green;">Command succeeded!</p>
    }
}

@code {

    private string accountIdInput = "";

    private decimal depositAmount;

    private string holderName = "";

    private decimal initialDeposit;

    private string? subscribedEntityId;

    private decimal withdrawAmount;

    /// <summary>
    ///     Gets the aggregate (write) feature state.
    /// </summary>
    private BankAccountAggregateState AggregateState => GetState<BankAccountAggregateState>();

    /// <summary>
    ///     Gets the projection data from the InletStore.
    /// </summary>
    private BankAccountBalanceProjectionDto? BalanceProjection => string.IsNullOrEmpty(AggregateState.EntityId) ? null : GetProjection<BankAccountBalanceProjectionDto>(AggregateState.EntityId);

    /// <summary>
    ///     Gets error message from aggregate state or projection error.
    /// </summary>
    private string? ErrorMessage
    {
        get
        {
            if (!string.IsNullOrEmpty(AggregateState.ErrorMessage))
            {
                return AggregateState.ErrorMessage;
            }

            if (!string.IsNullOrEmpty(AggregateState.EntityId))
            {
                Exception? projectionError = GetProjectionError<BankAccountBalanceProjectionDto>(AggregateState.EntityId);
                return projectionError?.Message;
            }

            return null;
        }
    }

    /// <summary>
    ///     Gets whether any operation is in progress.
    /// </summary>
    private bool IsExecutingOrLoading => AggregateState.IsExecuting || (!string.IsNullOrEmpty(AggregateState.EntityId) && IsProjectionLoading<BankAccountBalanceProjectionDto>(AggregateState.EntityId));

    /// <inheritdoc />
    protected override void Dispose(
        bool disposing
    )
    {
        // Unsubscribe when component is disposed
        if (disposing && !string.IsNullOrEmpty(subscribedEntityId))
        {
            UnsubscribeFromProjection<BankAccountBalanceProjectionDto>(subscribedEntityId);
        }

        base.Dispose(disposing);
    }

    /// <inheritdoc />
    protected override void OnAfterRender(
        bool firstRender
    )
    {
        base.OnAfterRender(firstRender);

        // Manage subscription based on current entity ID
        ManageProjectionSubscription();
    }

    private void Deposit() => Dispatch(new DepositFundsAction(AggregateState.EntityId!, depositAmount));

    private void ManageProjectionSubscription()
    {
        string? currentEntityId = AggregateState.EntityId;

        // If entity ID changed, update subscription
        if (currentEntityId != subscribedEntityId)
        {
            // Unsubscribe from previous entity
            if (!string.IsNullOrEmpty(subscribedEntityId))
            {
                UnsubscribeFromProjection<BankAccountBalanceProjectionDto>(subscribedEntityId);
            }

            // Subscribe to new entity
            if (!string.IsNullOrEmpty(currentEntityId))
            {
                SubscribeToProjection<BankAccountBalanceProjectionDto>(currentEntityId);
            }

            subscribedEntityId = currentEntityId;
        }
    }

    private void OpenAccount() => Dispatch(new OpenAccountAction(AggregateState.EntityId!, holderName, initialDeposit));

    private void SetEntityId() => Dispatch(new SetEntityIdAction(accountIdInput));

    private void Withdraw() => Dispatch(new WithdrawFundsAction(AggregateState.EntityId!, withdrawAmount));

}