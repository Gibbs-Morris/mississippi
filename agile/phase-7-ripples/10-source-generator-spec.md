# Ripples Source Generator Specification

**Status**: ðŸ”µ Design Document  
**Task**: 7.6 (expanded)

## Overview

This document specifies all source generators that power the Ripples developer experience. The generators eliminate boilerplate while maintaining type safety.

---

## Generator 1: Projection Controller Generator

### Trigger

`[UxProjection]` attribute on a record or class.

### Input

```csharp
namespace Cascade.Domain.Projections;

/// <summary>
/// Channel details projection.
/// </summary>
[UxProjection(Route = "channels")]  // Route is optional, defaults to kebab-case of type name
[GenerateSerializer]
public sealed record ChannelProjection
{
    [Id(0)] public required string Id { get; init; }
    [Id(1)] public required string Name { get; init; }
    [Id(2)] public required int MemberCount { get; init; }
}
```

### Output

```csharp
// <auto-generated/>
#nullable enable

using Microsoft.AspNetCore.Mvc;
using Mississippi.EventSourcing.UxProjections.Api;

namespace Cascade.Domain.Projections;

/// <summary>
/// API controller for <see cref="ChannelProjection"/> projection.
/// </summary>
[GeneratedCode("Mississippi.Ripples.Generators", "1.0.0")]
[Route("api/projections/channels/{entityId}")]
[ApiController]
public sealed partial class ChannelProjectionController 
    : UxProjectionControllerBase<ChannelProjection>
{
    /// <summary>
    /// Initializes a new instance of the <see cref="ChannelProjectionController"/> class.
    /// </summary>
    public ChannelProjectionController(
        IClusterClient clusterClient,
        ILogger<ChannelProjectionController> logger)
        : base(clusterClient, logger)
    {
    }
    
    /// <summary>
    /// Gets multiple projections in a single request.
    /// </summary>
    [HttpPost("batch")]
    public async Task<ActionResult<Dictionary<string, ChannelProjection>>> GetBatchAsync(
        [FromBody] BatchProjectionRequest request,
        CancellationToken cancellationToken = default)
    {
        return await GetBatchCoreAsync(request.EntityIds, cancellationToken);
    }
}
```

### Configuration Options

| Attribute Property | Type | Default | Description |
|--------------------|------|---------|-------------|
| `Route` | `string?` | Kebab-case of type name | Custom route segment |
| `EnableBatch` | `bool` | `true` | Generate batch endpoint |
| `Authorize` | `string?` | `null` | Authorization policy name |
| `Tags` | `string[]` | `[]` | OpenAPI tags |

---

## Generator 2: Aggregate Controller Generator

### Trigger

`[UxAggregate]` attribute on a grain interface.

### Input

```csharp
namespace Cascade.Domain.Aggregates;

/// <summary>
/// Channel aggregate operations.
/// </summary>
[UxAggregate(Route = "channels")]
public interface IChannelAggregateGrain : IAggregateGrain
{
    /// <summary>Creates a new channel.</summary>
    [CommandRoute("create")]
    Task<OperationResult> CreateAsync(CreateChannelCommand command);
    
    /// <summary>Renames the channel.</summary>
    [CommandRoute("rename")]
    Task<OperationResult> RenameAsync(RenameChannelCommand command);
    
    /// <summary>Archives the channel.</summary>
    [CommandRoute("archive")]
    Task<OperationResult> ArchiveAsync();
}
```

### Output

```csharp
// <auto-generated/>
#nullable enable

using Microsoft.AspNetCore.Mvc;
using Mississippi.EventSourcing.Aggregates;

namespace Cascade.Domain.Aggregates;

/// <summary>
/// API controller for <see cref="IChannelAggregateGrain"/> commands.
/// </summary>
[GeneratedCode("Mississippi.Ripples.Generators", "1.0.0")]
[Route("api/commands/channels/{entityId}")]
[ApiController]
public sealed partial class ChannelAggregateController : ControllerBase
{
    private IClusterClient ClusterClient { get; }
    private ILogger<ChannelAggregateController> Logger { get; }
    
    public ChannelAggregateController(
        IClusterClient clusterClient,
        ILogger<ChannelAggregateController> logger)
    {
        ClusterClient = clusterClient;
        Logger = logger;
    }
    
    /// <summary>Creates a new channel.</summary>
    [HttpPost("create")]
    [ProducesResponseType<OperationResult>(StatusCodes.Status200OK)]
    [ProducesResponseType<OperationResult>(StatusCodes.Status400BadRequest)]
    public async Task<ActionResult<OperationResult>> CreateAsync(
        [FromRoute] string entityId,
        [FromBody] CreateChannelCommand command,
        CancellationToken cancellationToken = default)
    {
        var grain = ClusterClient.GetGrain<IChannelAggregateGrain>(entityId);
        var result = await grain.CreateAsync(command);
        
        return result.IsSuccess 
            ? Ok(result) 
            : BadRequest(result);
    }
    
    /// <summary>Renames the channel.</summary>
    [HttpPost("rename")]
    [ProducesResponseType<OperationResult>(StatusCodes.Status200OK)]
    [ProducesResponseType<OperationResult>(StatusCodes.Status400BadRequest)]
    public async Task<ActionResult<OperationResult>> RenameAsync(
        [FromRoute] string entityId,
        [FromBody] RenameChannelCommand command,
        CancellationToken cancellationToken = default)
    {
        var grain = ClusterClient.GetGrain<IChannelAggregateGrain>(entityId);
        var result = await grain.RenameAsync(command);
        
        return result.IsSuccess 
            ? Ok(result) 
            : BadRequest(result);
    }
    
    /// <summary>Archives the channel.</summary>
    [HttpPost("archive")]
    [ProducesResponseType<OperationResult>(StatusCodes.Status200OK)]
    [ProducesResponseType<OperationResult>(StatusCodes.Status400BadRequest)]
    public async Task<ActionResult<OperationResult>> ArchiveAsync(
        [FromRoute] string entityId,
        CancellationToken cancellationToken = default)
    {
        var grain = ClusterClient.GetGrain<IChannelAggregateGrain>(entityId);
        var result = await grain.ArchiveAsync();
        
        return result.IsSuccess 
            ? Ok(result) 
            : BadRequest(result);
    }
}
```

---

## Generator 3: Route Registry Generator

### Trigger

Accumulates all `[UxProjection]` and `[UxAggregate]` attributes.

### Output

```csharp
// <auto-generated/>
#nullable enable

namespace Mississippi.Ripples;

/// <summary>
/// Registry of all projection and command routes for client-side URL construction.
/// </summary>
[GeneratedCode("Mississippi.Ripples.Generators", "1.0.0")]
public static partial class RouteRegistry
{
    /// <summary>Projection routes.</summary>
    public static class Projections
    {
        public static string ChannelProjection(string entityId) 
            => $"api/projections/channels/{entityId}";
        
        public static string ChannelProjectionBatch() 
            => "api/projections/channels/batch";
        
        public static string ChannelListProjection(string entityId) 
            => $"api/projections/channel-list/{entityId}";
    }
    
    /// <summary>Command routes.</summary>
    public static class Commands
    {
        public static string ChannelAggregate_Create(string entityId) 
            => $"api/commands/channels/{entityId}/create";
        
        public static string ChannelAggregate_Rename(string entityId) 
            => $"api/commands/channels/{entityId}/rename";
        
        public static string ChannelAggregate_Archive(string entityId) 
            => $"api/commands/channels/{entityId}/archive";
    }
}
```

---

## Generator 4: Ripple Registration Generator

### Trigger

Accumulates all `[UxProjection]` attributes.

### Output

```csharp
// <auto-generated/>
#nullable enable

using Microsoft.Extensions.DependencyInjection;
using Mississippi.Ripples;

namespace Microsoft.Extensions.DependencyInjection;

/// <summary>
/// Extension methods for registering generated Ripples.
/// </summary>
[GeneratedCode("Mississippi.Ripples.Generators", "1.0.0")]
public static partial class RippleServiceCollectionExtensions
{
    /// <summary>
    /// Adds all generated IRipple and IRipplePool registrations.
    /// </summary>
    public static IServiceCollection AddGeneratedRipples(
        this IServiceCollection services,
        RippleHostingMode mode = RippleHostingMode.Auto)
    {
        // ChannelProjection
        if (mode == RippleHostingMode.Server || mode == RippleHostingMode.Auto)
        {
            services.AddScoped<IRipple<ChannelProjection>, ServerRipple<ChannelProjection>>();
            services.AddScoped<IRipplePool<ChannelProjection>, ServerRipplePool<ChannelProjection>>();
        }
        else
        {
            services.AddScoped<IRipple<ChannelProjection>, ClientRipple<ChannelProjection>>();
            services.AddScoped<IRipplePool<ChannelProjection>, ClientRipplePool<ChannelProjection>>();
        }
        
        // ChannelListProjection
        if (mode == RippleHostingMode.Server || mode == RippleHostingMode.Auto)
        {
            services.AddScoped<IRipple<ChannelListProjection>, ServerRipple<ChannelListProjection>>();
        }
        else
        {
            services.AddScoped<IRipple<ChannelListProjection>, ClientRipple<ChannelListProjection>>();
        }
        
        // ... additional registrations
        
        return services;
    }
}

/// <summary>
/// Determines how Ripples connect to the backend.
/// </summary>
public enum RippleHostingMode
{
    /// <summary>Auto-detect based on hosting environment.</summary>
    Auto,
    
    /// <summary>Direct grain access (Blazor Server).</summary>
    Server,
    
    /// <summary>HTTP + SignalR (Blazor WASM).</summary>
    Client,
}
```

---

## Generator 5: Command Dispatcher Generator

### Trigger

`[UxAggregate]` attribute on a grain interface.

### Output

```csharp
// <auto-generated/>
#nullable enable

namespace Cascade.Domain.Aggregates;

/// <summary>
/// Strongly-typed command dispatcher for <see cref="IChannelAggregateGrain"/>.
/// </summary>
[GeneratedCode("Mississippi.Ripples.Generators", "1.0.0")]
public interface IChannelCommandDispatcher
{
    Task<OperationResult> CreateAsync(string entityId, CreateChannelCommand command);
    Task<OperationResult> RenameAsync(string entityId, RenameChannelCommand command);
    Task<OperationResult> ArchiveAsync(string entityId);
}

/// <summary>
/// Server implementation using direct grain access.
/// </summary>
[GeneratedCode("Mississippi.Ripples.Generators", "1.0.0")]
internal sealed class ServerChannelCommandDispatcher : IChannelCommandDispatcher
{
    private IClusterClient ClusterClient { get; }
    
    public ServerChannelCommandDispatcher(IClusterClient clusterClient)
    {
        ClusterClient = clusterClient;
    }
    
    public async Task<OperationResult> CreateAsync(string entityId, CreateChannelCommand command)
    {
        var grain = ClusterClient.GetGrain<IChannelAggregateGrain>(entityId);
        return await grain.CreateAsync(command);
    }
    
    public async Task<OperationResult> RenameAsync(string entityId, RenameChannelCommand command)
    {
        var grain = ClusterClient.GetGrain<IChannelAggregateGrain>(entityId);
        return await grain.RenameAsync(command);
    }
    
    public async Task<OperationResult> ArchiveAsync(string entityId)
    {
        var grain = ClusterClient.GetGrain<IChannelAggregateGrain>(entityId);
        return await grain.ArchiveAsync();
    }
}

/// <summary>
/// Client implementation using HTTP.
/// </summary>
[GeneratedCode("Mississippi.Ripples.Generators", "1.0.0")]
internal sealed class ClientChannelCommandDispatcher : IChannelCommandDispatcher
{
    private HttpClient Http { get; }
    
    public ClientChannelCommandDispatcher(HttpClient http)
    {
        Http = http;
    }
    
    public async Task<OperationResult> CreateAsync(string entityId, CreateChannelCommand command)
    {
        var response = await Http.PostAsJsonAsync(
            RouteRegistry.Commands.ChannelAggregate_Create(entityId), 
            command);
        return await response.Content.ReadFromJsonAsync<OperationResult>() 
            ?? OperationResult.Failure("Invalid response");
    }
    
    // ... other methods
}
```

---

## Project Structure for Generators

```
src/
â””â”€â”€ Ripples.Generators/
    â”œâ”€â”€ Ripples.Generators.csproj
    â”œâ”€â”€ RipplesGenerator.cs                    # Main entry point
    â”œâ”€â”€ Analyzers/
    â”‚   â”œâ”€â”€ UxProjectionAnalyzer.cs            # Validates [UxProjection] usage
    â”‚   â””â”€â”€ UxAggregateAnalyzer.cs             # Validates [UxAggregate] usage
    â”œâ”€â”€ Generators/
    â”‚   â”œâ”€â”€ ProjectionControllerGenerator.cs
    â”‚   â”œâ”€â”€ AggregateControllerGenerator.cs
    â”‚   â”œâ”€â”€ RouteRegistryGenerator.cs
    â”‚   â”œâ”€â”€ RippleRegistrationGenerator.cs
    â”‚   â””â”€â”€ CommandDispatcherGenerator.cs
    â”œâ”€â”€ Models/
    â”‚   â”œâ”€â”€ ProjectionInfo.cs                  # Extracted projection metadata
    â”‚   â”œâ”€â”€ AggregateInfo.cs                   # Extracted aggregate metadata
    â”‚   â””â”€â”€ CommandInfo.cs                     # Extracted command metadata
    â””â”€â”€ Templates/
        â”œâ”€â”€ ProjectionController.sbncs         # Scriban template
        â”œâ”€â”€ AggregateController.sbncs
        â”œâ”€â”€ RouteRegistry.sbncs
        â””â”€â”€ RippleRegistration.sbncs
```

---

## Analyzer Diagnostics

| Code | Severity | Message |
|------|----------|---------|
| `RP0001` | Error | `[UxProjection]` must be applied to a class or record |
| `RP0002` | Error | `[UxProjection]` types must have `[GenerateSerializer]` |
| `RP0003` | Warning | Route "{0}" conflicts with existing projection |
| `RP0004` | Error | `[UxAggregate]` must be applied to an interface |
| `RP0005` | Error | `[UxAggregate]` interface must inherit from `IAggregateGrain` |
| `RP0006` | Warning | Command method should return `Task<OperationResult>` |
| `RP0007` | Info | Consider adding `[CommandRoute]` for explicit routing |

---

## Code Fix Providers

### RP0002: Add Missing Serializer

```csharp
// Before
[UxProjection]
public record MyProjection { }

// After (code fix applied)
[UxProjection]
[GenerateSerializer]
public record MyProjection { }
```

### RP0007: Add Command Route

```csharp
// Before
[UxAggregate]
public interface IMyGrain : IAggregateGrain
{
    Task<OperationResult> DoSomethingAsync(MyCommand cmd);
}

// After (code fix applied)
[UxAggregate]
public interface IMyGrain : IAggregateGrain
{
    [CommandRoute("do-something")]
    Task<OperationResult> DoSomethingAsync(MyCommand cmd);
}
```
