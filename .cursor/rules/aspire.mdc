---
description: Aspire Integration Testing
globs: ["**/*.cs"]
alwaysApply: false
---
# Aspire Integration Testing
**Source:** .github/instructions/aspire.instructions.md


# Aspire Integration Testing

Governing thought: Use the preview Cosmos emulator with HTTP mode and SDK workarounds to avoid known connectivity issues.

> Drift check: Check [Aspire Cosmos issues](https://github.com/dotnet/aspire/issues?q=cosmos+emulator) and [Cosmos SDK issues](https://github.com/Azure/azure-cosmos-dotnet-v3/issues) for updates before changing emulator configuration.

## Rules (RFC 2119)

- Cosmos emulator **MUST** use `RunAsPreviewEmulator()` with `WithoutHttpsCertificate()`; legacy Linux emulator has unreliable health checks. Why: Preview emulator has proper HTTP `/ready` endpoint. See [Aspire #7882](https://github.com/dotnet/aspire/issues/7882).
- `CosmosClientOptions` **MUST** set `LimitToEndpoint = true` when connecting to any emulator. Why: SDK hangs trying to discover replicas on single-node emulator. See [SDK #5364](https://github.com/Azure/azure-cosmos-dotnet-v3/issues/5364).
- `CosmosClientOptions` **SHOULD** use `ConnectionMode.Gateway` for emulator connections. Why: Gateway mode is more reliable than Direct TCP for local emulators.
- Cosmos document models **MUST** use `[Newtonsoft.Json.JsonProperty("id")]` not `System.Text.Json` attributes. Why: Cosmos SDK v3 uses Newtonsoft.Json by default; STJ attributes are ignored.
- Aspire test projects **SHOULD** use `IAsyncLifetime` fixture pattern to manage AppHost lifecycle. Why: Ensures proper startup/teardown and resource cleanup.

## Scope and Audience

Developers building Aspire-based integration tests with Azure emulators.

## At-a-Glance Quick-Start

AppHost configuration:

```csharp
builder.AddAzureCosmosDB("cosmos")
    .RunAsPreviewEmulator(emulator =>
    {
        emulator.WithDataExplorer();
        emulator.WithoutHttpsCertificate(); // HTTP mode
    });
```

SDK client configuration:

```csharp
CosmosClientOptions options = new()
{
    ConnectionMode = ConnectionMode.Gateway,
    LimitToEndpoint = true, // CRITICAL: prevents replica discovery hang
};
```

Document model:

```csharp
public class MyDocument
{
    [Newtonsoft.Json.JsonProperty("id")]
    public string Id { get; set; } = string.Empty;
}
```

## Known Issues Reference

| Issue | Symptom | Fix |
|-------|---------|-----|
| [SDK #5364](https://github.com/Azure/azure-cosmos-dotnet-v3/issues/5364) | SDK hangs on connection | `LimitToEndpoint = true` |
| [Aspire #7882](https://github.com/dotnet/aspire/issues/7882) | Health check passes before ready | Use preview emulator |
| Newtonsoft vs STJ | "Document does not contain id" | Use `Newtonsoft.Json.JsonProperty` |

## Core Principles

- Preview emulator over legacy Linux emulator
- HTTP mode eliminates certificate complexity
- SDK needs explicit single-endpoint mode for emulators

## References

- Sample implementation: `samples/Crescent/Aspire.L2Tests/`
- Shared guardrails: `.github/instructions/shared-policies.instructions.md`
- Testing guidance: `.github/instructions/testing.instructions.md`
