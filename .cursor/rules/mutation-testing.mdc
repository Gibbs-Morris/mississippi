---
description: Mutation Testing Playbook
alwaysApply: true
---
# Mutation Testing Playbook
**Source:** .github/instructions/mutation-testing.instructions.md


# Mutation Testing Playbook

Governing thought: Use this checklist whenever you need to run Mississippi mutation tests or close surviving mutants, following exact steps while deferring architecture, C#, logging, Orleans, and testing nuances to their dedicated instruction files.

## Rules (RFC 2119)

- Agents **MUST** run `dotnet tool restore` at least once before starting mutation testing.  
  Why: Ensures required tools (Stryker.NET) are available.
- Agents **MUST** run a clean build before mutation testing to surface compiler/analyzer issues.  
  Why: Mutation testing on broken code wastes time and produces invalid results.
- Agents **MUST** allow mutation test scripts to run for up to 30 minutes without canceling.  
  Why: Mutation testing is intentionally long-running; early cancellation produces incomplete results.
- Agents **MUST** commit generated report paths for traceability.  
  Why: Maintains audit trail of mutation test results.
- Agents **MUST NOT** change production code to kill mutants unless provably unkillable through tests alone.  
  Why: Preserves production code behavior; tests should catch issues, not modify behavior.
- Agents **MUST** fix all build warnings and test failures before continuing mutation work.  
  Why: Quality gates ensure changes don't introduce regressions.
- Agents **SHOULD** use the summarizer script with `-SkipMutationRun` for iterative work.  
  Why: Avoids re-running expensive mutation tests when analyzing existing results.
- Agents **SHOULD** prioritize high-impact survivors using the ranking system.  
  Why: Maximizes value by addressing most critical test gaps first.

## Scope and Audience

**Audience:** Developers and agents running mutation tests on Mississippi solution projects.

**In scope:** Mutation testing workflow, survivor prioritization, quality gates, automation scripts.

**Out of scope:** General testing strategy (see testing.instructions.md), specific C# patterns (see csharp.instructions.md).

> **Drift check:** Before running any PowerShell script referenced here, open the script in `eng/src/agent-scripts/` (or the specified path) to confirm its current behavior matches this guidance. Treat this document as best-effort context—the scripts remain the source of truth for step ordering and options.

## Purpose

This playbook provides a systematic workflow for running mutation tests, prioritizing survivors, and improving test quality through targeted test additions.

## Core Principles

- All repository-wide guidance in `.github/instructions/*.instructions.md` remains authoritative
- Resolve conflicts by choosing the most specific file first (feature → language → build)
- Mirror instruction changes to Cursor rules via `sync-instructions-to-mdc.ps1`
- Scripts remain the source of truth for parameters and behavior

## Procedures

### Execution Loop

1. **Prep tools** – Ensure `dotnet tool restore` has been run at least once on the repo.
2. **Clean build** – Run `pwsh ./eng/src/agent-scripts/build-mississippi-solution.ps1` to surface compiler/analyzer issues before mutation work.
3. **Baseline mutation test** – Execute `pwsh ./eng/src/agent-scripts/mutation-test-mississippi-solution.ps1`. Always commit the generated report paths for traceability. Expect this script to run for up to 30 minutes; stay on the run until it completes and do not cancel early.
4. **Collect & prioritize survivors** – Open the newest `.scratchpad/mutation-test-results/**/reports/mutation-report.json` only if deep inspection is needed. Otherwise run the summarizer (it reruns the mutation script unless you pass `-SkipMutationRun`):
   - `pwsh ./eng/src/agent-scripts/summarize-mutation-survivors.ps1` (defaults to weighted scoring, full list)
   - Outputs:
   - Basic JSON: `.scratchpad/mutation-test-results/mutation-survivors-summary.json` (backward compatibility)
   - Enriched JSON: `.scratchpad/mutation-test-results/mutation-survivors-enriched.json` (schemaVersion, focusOrder, aggregates, snippets)
   - Report JSON: `.scratchpad/mutation-test-results/mutation-survivors-report.json` (raw survivors from the latest `mutation-report.json` when available)
       - Markdown: `.scratchpad/testing/mutation-survivors-summary.md` (includes prioritized focus table, details, mutator strategy cheat sheet)
   - **Scratchpad Tasks (auto)**: `.scratchpad/tasks/pending/*.json` — every run deterministically syncs surviving mutants into per-mutation task files. Existing tasks are matched via `mutationKey`, so reruns won’t create duplicates. Delete a task (or clear the folder) and rerun the summarizer to regenerate it.
   - Optional parameters for focused iteration:
       - `-SkipMutationRun`: Use existing Stryker output without invoking `mutation-test-mississippi-solution.ps1` again.
       - `-MutationScriptPath <Path>`: Point to an alternate mutation script when the default Mississippi script isn't desired.
       - `-Top <N>`: Only keep top N ranked survivors.
       - `-ContextLines <N>`: Embed N lines of code context before/after the mutant (default 3).
       - `-ScoringMode Simple|Weighted`: Simple = no heuristic weights; Weighted = mutator + density + missing-tests weighting.
       - `-Project <Name>`: Filter survivors to a single source project (by directory under `src/`).
       - `-VerboseRanking`: Append a breakdown of score components.
       - `-GenerateTasks`: Emit/update `.scratchpad/testing/mutation-tasks.md` with a table (Status, Rank, Score, File, Mutator, Suggestion).
       - `-TasksPath <Path>`: Override the default `.scratchpad/testing/mutation-tasks.md` location.
       - `-EmitTestSkeletons`: Generate/append mutation test skeletons under the first matching test project `tests/<Project>.*/Mutation/GeneratedMutationTests.cs`.
          - Use `-OverwriteSkeletons` to recreate the file from scratch.
   - Example focused loop (top 5 high-impact):

   ```powershell
   pwsh ./eng/src/agent-scripts/summarize-mutation-survivors.ps1 -SkipMutationRun -Top 5 -ContextLines 4 -GenerateTasks -EmitTestSkeletons
      ```

   - Each survivor row includes a suggestion (how to kill) and snippet so AI agents can author tests without re-reading the entire file.
   - The summarizer automatically mirrors prioritized survivors into `.scratchpad/tasks/pending` (one JSON per survivor) for agent handoff (see `.github/instructions/agent-scratchpad.instructions.md`). The scratchpad is ephemeral and ignored by Git; do not reference it from source or tests.
5. **Targeted tests only** – Add or adjust tests in the matching `tests/` project using repository patterns (naming, logging, DI seams). Do not change production code unless a mutant is provably unkillable without it; document that case inside the task file.
6. **Quality gates** – After adding tests, run:
   - `pwsh ./eng/src/agent-scripts/unit-test-mississippi-solution.ps1`
   - `pwsh ./eng/src/agent-scripts/build-mississippi-solution.ps1`
   Fix every warning or failure before continuing.
7. **Re-run mutation tests** – Execute step 3 again. Update task statuses to `Done` when a mutant dies, or capture justification under `Status = Deferred` if it remains.
8. **Repeat** – Iterate steps 4–7 until no survivors remain or only documented deferrals persist. Keep the task file deterministic (sorted by project, file, line) throughout.

## Completion Checklist

- [ ] Zero surviving mutants or documented exceptions in `.scratchpad/testing/mutation-tasks.md`
- [ ] All builds, unit tests, and cleanup scripts pass with zero warnings
- [ ] Instruction Markdown and Cursor `.mdc` rules are in sync via `sync-instructions-to-mdc.ps1`

## Prioritized Survivor Workflow (Recommended)

1. Run baseline mutation test (Execution Loop step 3).
2. Generate ranked survivors (top N for fast focus):

   ```powershell
   pwsh ./eng/src/agent-scripts/summarize-mutation-survivors.ps1 -SkipMutationRun -Top 10 -GenerateTasks -EmitTestSkeletons
   ```

3. Open `.scratchpad/testing/mutation-tasks.md`; take the first `Todo` (Rank 1 highest score).
4. Fill in or extend the generated skeleton in `GeneratedMutationTests.cs` (or create a dedicated test if more appropriate).
5. Run fast quality loop for the impacted test project:

   ```powershell
   pwsh ./eng/src/agent-scripts/test-project-quality.ps1 -TestProject <Project>.Tests -SkipMutation
   ```

6. If test passes and kills survivor, re-run summarizer (with `-SkipMutationRun` if you have not rerun Stryker yet) or re-run full mutation test to validate.
7. Repeat until `focusOrder` empty or only justifiable deferrals remain.

## Mutator Strategy Reference

| Mutator | What It Usually Means | How To Kill It |
| ------- | --------------------- | -------------- |
| ConditionalBoundary | Missing exact edge (==, <=, >=) case | Add boundary input(s) asserting both sides of branch |
| NegateCondition | Only one branch asserted | Add test where predicate is false/alternate path |
| ArithmeticOperator | Numeric result loosely validated | Assert precise arithmetic across varied (negative/zero/boundary) inputs |
| LogicalOperator | Not all clause combinations covered | Add permutations to toggle each clause independently |
| Boolean | Single boolean path exercised | Add opposite boolean scenario |
| String | Insufficient string content validation | Assert full string (case, whitespace, format) |
| Assignment | State change not asserted | Assert mutated property/field after operation |
| RemoveCall / MethodCall | Side-effect or call result unverified | Assert side-effect or verify interaction / returned value |

Use the summarizer's suggestion column as an immediate next action hint; refine assertions rather than broadening mocks.

## Task File Notes

- `.scratchpad/testing/mutation-tasks.md` is ephemeral; regenerate anytime with `-GenerateTasks`.
- Update `Status` manually to `Done` or `Deferred` (include justification for deferrals—design constraints, unreachable path, or verified false positive).
- Keep ordering stable (do not manually reorder ranked entries unless you re-run with different filters).

## Test Skeleton Guidance

- Generated skeletons are placed in `Mutation/GeneratedMutationTests.cs` to avoid cluttering domain-focused test files.
- Replace `Assert.True(true)` with meaningful assertions quickly—leaving placeholders risks masking assertion gaps.
- If a skeleton requires significant setup, consider extracting a helper builder or fixture; keep it in the test project.

## Schema Versioning

- Enriched JSON (`mutation-survivors-enriched.json`) includes `schemaVersion` (current: `1.1.0`).
- Backward compatible basic JSON array persists for existing automation.
- When extending schema: bump minor version, document new properties, do not remove existing ones without deprecation notice.

## Deferral Criteria

Defer only when ALL apply:

- Mutant cannot be killed without a non-trivial production refactor AND
- Behavior is already thoroughly asserted from a business perspective AND
- Refactor risk/time outweighs value for current iteration.

Record deferral rationale inline in `.scratchpad/testing/mutation-tasks.md` (add brief reason after the row or in a trailing comment block).
