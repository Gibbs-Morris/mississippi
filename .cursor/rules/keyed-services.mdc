---
description: Keyed Services for Storage Providers
globs: ["**/*.cs"]
alwaysApply: false
---
# Keyed Services for Storage Providers
**Source:** .github/instructions/keyed-services.instructions.md


# Keyed Services for Storage Providers

Governing thought: Use keyed DI services for storage clients so multiple instances (Cosmos, Blob, Redis, etc.) can coexist in a single host for different purposes.

> Drift check: Review `MississippiDefaults` in `Common.Abstractions` and Aspire registration patterns before adding new keyed services.

## Rules (RFC 2119)

- Library code that consumes cloud clients (BlobServiceClient, CosmosClient, Container, etc.) **MUST** use `[FromKeyedServices(MississippiDefaults.ServiceKeys.XxxYyy)]` on constructor parameters rather than expecting an unkeyed registration. Why: Enterprise apps require multiple storage accounts for different purposes (locking, state, uploads, archival).
- All Mississippi service keys **MUST** be defined in `MississippiDefaults.ServiceKeys` in `Common.Abstractions`. Why: Single source of truth prevents key collisions and drift.
- Key constants **MUST** follow the pattern `"mississippi-{client-type}-{feature}"` (e.g., `"mississippi-cosmos-brooks"`, `"mississippi-blob-locking"`). Why: Provides unique, discoverable identifiers.
- Registration documentation **MUST** comment which keyed services the library expects callers to provide. Why: Clarifies the DI contract.
- Host applications **MUST** forward from their registration key (e.g., Aspire's `"cosmos"`, `"blobs"`) to the library's expected key using `AddKeyedSingleton`. Why: Decouples host naming from library requirements.
- When a host needs both keyed (for library) and unkeyed (for its own services), it **MUST** explicitly forward using `AddSingleton(sp => sp.GetRequiredKeyedService<T>("key"))`. Why: Makes DI resolution explicit.

## Scope and Audience

Library authors and host developers integrating Mississippi with cloud storage or external services.

## At-a-Glance Quick-Start

### Library Side

```csharp
// Use centralized keys from MississippiDefaults
public BlobDistributedLockManager(
    [FromKeyedServices(MississippiDefaults.ServiceKeys.BlobLocking)]
    BlobServiceClient blobServiceClient,
    ILogger<BlobDistributedLockManager> logger) { }

// Document in registration comments
// Caller must register a keyed BlobServiceClient with MississippiDefaults.ServiceKeys.BlobLocking
services.AddSingleton<IDistributedLockManager, BlobDistributedLockManager>();
```

### Host Side (Aspire)

```csharp
// Register with Aspire key
builder.AddKeyedAzureBlobServiceClient("blobs");

// Forward to library key
builder.Services.AddKeyedSingleton(
    MississippiDefaults.ServiceKeys.BlobLocking,
    (sp, _) => sp.GetRequiredKeyedService<BlobServiceClient>("blobs"));

// If host also needs unkeyed for its own services
builder.Services.AddSingleton(sp => sp.GetRequiredKeyedService<BlobServiceClient>("blobs"));
```

## Core Principles

- One client type, many instances: keyed services enable coexistence.
- All Mississippi keys centralized in `MississippiDefaults.ServiceKeys`.
- Library keys are stable contracts; host keys are deployment-specific.
- Explicit forwarding makes the DI graph auditable.

## MississippiDefaults Reference

| Key | Value | Purpose |
|-----|-------|---------|
| `ServiceKeys.CosmosBrooks` | `"mississippi-cosmos-brooks"` | Cosmos container for event streams |
| `ServiceKeys.CosmosSnapshots` | `"mississippi-cosmos-snapshots"` | Cosmos container for snapshots |
| `ServiceKeys.BlobLocking` | `"mississippi-blob-locking"` | Blob storage for distributed locking |

See also: `MississippiDefaults.ContainerIds`, `MississippiDefaults.StreamNamespaces` for other unified defaults.

## References

- Service registration: `.github/instructions/service-registration.instructions.md`
- Shared guardrails: `.github/instructions/shared-policies.instructions.md`
