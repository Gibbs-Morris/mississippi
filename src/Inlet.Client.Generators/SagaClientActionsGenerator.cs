using System.Collections.Generic;
using System.Linq;
using System.Text;

using Microsoft.CodeAnalysis;
using Microsoft.CodeAnalysis.Diagnostics;
using Microsoft.CodeAnalysis.Text;

using Mississippi.Inlet.Generators.Core.Analysis;
using Mississippi.Inlet.Generators.Core.Emit;
using Mississippi.Inlet.Generators.Core.Naming;


namespace Mississippi.Inlet.Client.Generators;

/// <summary>
///     Generates client-side Flux actions for sagas marked with [GenerateSagaEndpoints].
/// </summary>
[Generator(LanguageNames.CSharp)]
public sealed class SagaClientActionsGenerator : IIncrementalGenerator
{
    private static void GenerateActions(
        SourceProductionContext context,
        SagaClientGeneratorHelper.SagaClientInfo saga
    )
    {
        GeneratePrimaryAction(context, saga);
        GenerateExecutingAction(context, saga);
        GenerateSucceededAction(context, saga);
        GenerateFailedAction(context, saga);
    }

    private static void GenerateExecutingAction(
        SourceProductionContext context,
        SagaClientGeneratorHelper.SagaClientInfo saga
    )
    {
        string actionName = $"Start{saga.SagaName}SagaExecutingAction";
        SourceBuilder sb = new();
        sb.AppendAutoGeneratedHeader();
        sb.AppendUsing("System");
        sb.AppendUsing("Mississippi.Inlet.Client.Abstractions.Actions");
        sb.AppendFileScopedNamespace(saga.ActionsNamespace);
        sb.AppendLine();
        sb.AppendSummary($"Action dispatched when the {saga.SagaName} saga start request is executing.");
        sb.AppendLine("/// <param name=\"CommandId\">The unique command invocation identifier.</param>");
        sb.AppendLine("/// <param name=\"CommandType\">The name of the command type.</param>");
        sb.AppendLine("/// <param name=\"Timestamp\">The timestamp when the request started.</param>");
        sb.AppendGeneratedCodeAttribute("SagaClientActionsGenerator");
        sb.AppendLine(
            $"internal sealed record {actionName}(string CommandId, string CommandType, DateTimeOffset Timestamp)");
        sb.IncreaseIndent();
        sb.AppendLine($": ICommandExecutingAction<{actionName}>");
        sb.DecreaseIndent();
        sb.OpenBrace();
        sb.AppendLine("/// <inheritdoc />");
        sb.AppendLine($"public static {actionName} Create(");
        sb.IncreaseIndent();
        sb.AppendLine("string commandId,");
        sb.AppendLine("string commandType,");
        sb.AppendLine("DateTimeOffset timestamp");
        sb.DecreaseIndent();
        sb.AppendLine(") =>");
        sb.IncreaseIndent();
        sb.AppendLine("new(commandId, commandType, timestamp);");
        sb.DecreaseIndent();
        sb.CloseBrace();
        context.AddSource($"{actionName}.g.cs", SourceText.From(sb.ToString(), Encoding.UTF8));
    }

    private static void GenerateFailedAction(
        SourceProductionContext context,
        SagaClientGeneratorHelper.SagaClientInfo saga
    )
    {
        string actionName = $"Start{saga.SagaName}SagaFailedAction";
        SourceBuilder sb = new();
        sb.AppendAutoGeneratedHeader();
        sb.AppendUsing("System");
        sb.AppendUsing("Mississippi.Inlet.Client.Abstractions.Actions");
        sb.AppendFileScopedNamespace(saga.ActionsNamespace);
        sb.AppendLine();
        sb.AppendSummary($"Action dispatched when the {saga.SagaName} saga start request fails.");
        sb.AppendLine("/// <param name=\"CommandId\">The unique command invocation identifier.</param>");
        sb.AppendLine("/// <param name=\"ErrorCode\">The error code.</param>");
        sb.AppendLine("/// <param name=\"ErrorMessage\">The error message.</param>");
        sb.AppendLine("/// <param name=\"Timestamp\">The timestamp when the request failed.</param>");
        sb.AppendGeneratedCodeAttribute("SagaClientActionsGenerator");
        sb.AppendLine($"internal sealed record {actionName}(");
        sb.IncreaseIndent();
        sb.AppendLine("string CommandId,");
        sb.AppendLine("string? ErrorCode,");
        sb.AppendLine("string? ErrorMessage,");
        sb.AppendLine("DateTimeOffset Timestamp");
        sb.DecreaseIndent();
        sb.AppendLine(") : ICommandFailedAction<" + actionName + ">");
        sb.OpenBrace();
        sb.AppendLine("/// <inheritdoc />");
        sb.AppendLine($"public static {actionName} Create(");
        sb.IncreaseIndent();
        sb.AppendLine("string commandId,");
        sb.AppendLine("string? errorCode,");
        sb.AppendLine("string? errorMessage,");
        sb.AppendLine("DateTimeOffset timestamp");
        sb.DecreaseIndent();
        sb.AppendLine(") =>");
        sb.IncreaseIndent();
        sb.AppendLine("new(commandId, errorCode, errorMessage, timestamp);");
        sb.DecreaseIndent();
        sb.CloseBrace();
        context.AddSource($"{actionName}.g.cs", SourceText.From(sb.ToString(), Encoding.UTF8));
    }

    private static void GeneratePrimaryAction(
        SourceProductionContext context,
        SagaClientGeneratorHelper.SagaClientInfo saga
    )
    {
        string actionName = $"Start{saga.SagaName}SagaAction";
        SourceBuilder sb = new();
        sb.AppendAutoGeneratedHeader();
        sb.AppendUsing("System");
        sb.AppendUsing("Mississippi.Inlet.Client.Abstractions.Actions");
        sb.AppendFileScopedNamespace(saga.ActionsNamespace);
        sb.AppendLine();
        sb.AppendSummary($"Action dispatched to start the {saga.SagaName} saga.");
        sb.AppendLine("/// <remarks>");
        sb.AppendLine($"///     Derived from saga input: <c>{saga.InputTypeName}</c>.");
        sb.AppendLine("/// </remarks>");
        sb.AppendLine("/// <param name=\"SagaId\">The saga identifier.</param>");
        saga.InputProperties.ToList()
            .ForEach(prop => sb.AppendLine(
                $"/// <param name=\"{prop.Name}\">The {NamingConventions.ToCamelCase(prop.Name)} value.</param>"));
        sb.AppendLine("/// <param name=\"CorrelationId\">The optional correlation identifier.</param>");
        sb.AppendGeneratedCodeAttribute("SagaClientActionsGenerator");
        StringBuilder parameters = new();
        parameters.Append("Guid SagaId");
        foreach (PropertyModel prop in saga.InputProperties)
        {
            parameters.Append(", ").Append(prop.SourceTypeName).Append(' ').Append(prop.Name);
        }

        parameters.Append(", string? CorrelationId");
        sb.AppendLine($"internal sealed record {actionName}({parameters}) : ICommandAction");
        sb.OpenBrace();
        sb.AppendLine("/// <inheritdoc />");
        sb.AppendLine("public string EntityId => SagaId.ToString();");
        sb.CloseBrace();
        context.AddSource($"{actionName}.g.cs", SourceText.From(sb.ToString(), Encoding.UTF8));
    }

    private static void GenerateSucceededAction(
        SourceProductionContext context,
        SagaClientGeneratorHelper.SagaClientInfo saga
    )
    {
        string actionName = $"Start{saga.SagaName}SagaSucceededAction";
        SourceBuilder sb = new();
        sb.AppendAutoGeneratedHeader();
        sb.AppendUsing("System");
        sb.AppendUsing("Mississippi.Inlet.Client.Abstractions.Actions");
        sb.AppendFileScopedNamespace(saga.ActionsNamespace);
        sb.AppendLine();
        sb.AppendSummary($"Action dispatched when the {saga.SagaName} saga start request succeeds.");
        sb.AppendLine("/// <param name=\"CommandId\">The unique command invocation identifier.</param>");
        sb.AppendLine("/// <param name=\"Timestamp\">The timestamp when the request succeeded.</param>");
        sb.AppendGeneratedCodeAttribute("SagaClientActionsGenerator");
        sb.AppendLine(
            $"internal sealed record {actionName}(string CommandId, DateTimeOffset Timestamp) : ICommandSucceededAction<{actionName}>");
        sb.OpenBrace();
        sb.AppendLine("/// <inheritdoc />");
        sb.AppendLine($"public static {actionName} Create(");
        sb.IncreaseIndent();
        sb.AppendLine("string commandId,");
        sb.AppendLine("DateTimeOffset timestamp");
        sb.DecreaseIndent();
        sb.AppendLine(") =>");
        sb.IncreaseIndent();
        sb.AppendLine("new(commandId, timestamp);");
        sb.DecreaseIndent();
        sb.CloseBrace();
        context.AddSource($"{actionName}.g.cs", SourceText.From(sb.ToString(), Encoding.UTF8));
    }

    /// <inheritdoc />
    public void Initialize(
        IncrementalGeneratorInitializationContext context
    )
    {
        IncrementalValueProvider<(Compilation Compilation, AnalyzerConfigOptionsProvider Options)>
            compilationAndOptions = context.CompilationProvider.Combine(context.AnalyzerConfigOptionsProvider);
        IncrementalValueProvider<List<SagaClientGeneratorHelper.SagaClientInfo>> sagasProvider =
            compilationAndOptions.Select((
                source,
                _
            ) => SagaClientGeneratorHelper.GetSagasFromCompilation(source.Compilation, source.Options));
        context.RegisterSourceOutput(
            sagasProvider,
            static (
                spc,
                sagas
            ) =>
            {
                foreach (SagaClientGeneratorHelper.SagaClientInfo saga in sagas)
                {
                    GenerateActions(spc, saga);
                }
            });
    }
}