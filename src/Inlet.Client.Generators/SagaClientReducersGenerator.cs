using System.Collections.Generic;
using System.Text;

using Microsoft.CodeAnalysis;
using Microsoft.CodeAnalysis.Diagnostics;
using Microsoft.CodeAnalysis.Text;

using Mississippi.Inlet.Generators.Core.Emit;


namespace Mississippi.Inlet.Client.Generators;

/// <summary>
///     Generates client-side reducers for saga start actions.
/// </summary>
[Generator(LanguageNames.CSharp)]
public sealed class SagaClientReducersGenerator : IIncrementalGenerator
{
    private static void GenerateReducers(
        SourceProductionContext context,
        SagaClientGeneratorHelper.SagaClientInfo saga
    )
    {
        string reducersTypeName = $"{saga.SagaName}SagaReducers";
        string stateTypeName = $"{saga.SagaName}SagaState";
        string actionPrefix = $"Start{saga.SagaName}Saga";
        SourceBuilder sb = new();
        sb.AppendAutoGeneratedHeader();
        sb.AppendUsing("Mississippi.Inlet.Client.Abstractions");
        sb.AppendLine();
        sb.AppendLine($"using {saga.ActionsNamespace};");
        sb.AppendLine($"using {saga.StateNamespace};");
        sb.AppendFileScopedNamespace(saga.ReducersNamespace);
        sb.AppendLine();
        sb.AppendSummary($"Pure reducer functions for the {saga.SagaName}Saga feature state.");
        sb.AppendLine("/// <remarks>");
        sb.AppendLine("///     <para>");
        sb.AppendLine(
            "///         Each saga start request has lifecycle reducers (Executing, Failed, Succeeded) that delegate");
        sb.AppendLine("///         to <see cref=\"AggregateCommandStateReducers\" /> for standard tracking logic.");
        sb.AppendLine("///     </para>");
        sb.AppendLine("/// </remarks>");
        sb.AppendGeneratedCodeAttribute("SagaClientReducersGenerator");
        sb.AppendLine($"internal static class {reducersTypeName}");
        sb.OpenBrace();
        sb.AppendLine($"// {actionPrefix} reducers");
        sb.AppendLine();
        sb.AppendLine("/// <summary>");
        sb.AppendLine($"///     Updates state when {actionPrefix} starts executing.");
        sb.AppendLine("/// </summary>");
        sb.AppendLine("/// <param name=\"state\">The current state.</param>");
        sb.AppendLine("/// <param name=\"action\">The action to reduce.</param>");
        sb.AppendLine("/// <returns>The new state with command tracked.</returns>");
        sb.AppendLine($"public static {stateTypeName} {actionPrefix}Executing(");
        sb.IncreaseIndent();
        sb.AppendLine($"{stateTypeName} state,");
        sb.AppendLine($"{actionPrefix}ExecutingAction action");
        sb.DecreaseIndent();
        sb.AppendLine(") =>");
        sb.IncreaseIndent();
        sb.AppendLine("AggregateCommandStateReducers.ReduceCommandExecuting(state, action);");
        sb.DecreaseIndent();
        sb.AppendLine();
        sb.AppendLine("/// <summary>");
        sb.AppendLine($"///     Updates state when {actionPrefix} fails.");
        sb.AppendLine("/// </summary>");
        sb.AppendLine("/// <param name=\"state\">The current state.</param>");
        sb.AppendLine("/// <param name=\"action\">The action containing error details.</param>");
        sb.AppendLine("/// <returns>The new state with error populated.</returns>");
        sb.AppendLine($"public static {stateTypeName} {actionPrefix}Failed(");
        sb.IncreaseIndent();
        sb.AppendLine($"{stateTypeName} state,");
        sb.AppendLine($"{actionPrefix}FailedAction action");
        sb.DecreaseIndent();
        sb.AppendLine(") =>");
        sb.IncreaseIndent();
        sb.AppendLine("AggregateCommandStateReducers.ReduceCommandFailed(state, action);");
        sb.DecreaseIndent();
        sb.AppendLine();
        sb.AppendLine("/// <summary>");
        sb.AppendLine($"///     Updates state when {actionPrefix} succeeds.");
        sb.AppendLine("/// </summary>");
        sb.AppendLine("/// <param name=\"state\">The current state.</param>");
        sb.AppendLine("/// <param name=\"action\">The action to reduce.</param>");
        sb.AppendLine("/// <returns>The new state with success set.</returns>");
        sb.AppendLine($"public static {stateTypeName} {actionPrefix}Succeeded(");
        sb.IncreaseIndent();
        sb.AppendLine($"{stateTypeName} state,");
        sb.AppendLine($"{actionPrefix}SucceededAction action");
        sb.DecreaseIndent();
        sb.AppendLine(") =>");
        sb.IncreaseIndent();
        sb.AppendLine("AggregateCommandStateReducers.ReduceCommandSucceeded(state, action);");
        sb.DecreaseIndent();
        sb.CloseBrace();
        context.AddSource($"{reducersTypeName}.g.cs", SourceText.From(sb.ToString(), Encoding.UTF8));
    }

    /// <inheritdoc />
    public void Initialize(
        IncrementalGeneratorInitializationContext context
    )
    {
        IncrementalValueProvider<(Compilation Compilation, AnalyzerConfigOptionsProvider Options)>
            compilationAndOptions = context.CompilationProvider.Combine(context.AnalyzerConfigOptionsProvider);
        IncrementalValueProvider<List<SagaClientGeneratorHelper.SagaClientInfo>> sagasProvider =
            compilationAndOptions.Select((
                source,
                _
            ) => SagaClientGeneratorHelper.GetSagasFromCompilation(source.Compilation, source.Options));
        context.RegisterSourceOutput(
            sagasProvider,
            static (
                spc,
                sagas
            ) =>
            {
                foreach (SagaClientGeneratorHelper.SagaClientInfo saga in sagas)
                {
                    GenerateReducers(spc, saga);
                }
            });
    }
}