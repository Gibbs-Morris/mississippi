using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;

using Microsoft.CodeAnalysis;
using Microsoft.CodeAnalysis.Diagnostics;
using Microsoft.CodeAnalysis.Text;

using Mississippi.Inlet.Generators.Core.Emit;
using Mississippi.Inlet.Generators.Core.Naming;


namespace Mississippi.Inlet.Client.Generators;

/// <summary>
///     Generates client-side saga feature registration extension methods.
/// </summary>
[Generator(LanguageNames.CSharp)]
public sealed class SagaClientRegistrationGenerator : IIncrementalGenerator
{
    private const string GenerateSagaEndpointsAttributeFullName =
        "Mississippi.Inlet.Generators.Abstractions.GenerateSagaEndpointsAttribute";

    private const string GeneratorName = "SagaClientRegistrationGenerator";

    private const string ISagaDefinitionFullName = "Mississippi.EventSourcing.Sagas.Abstractions.ISagaDefinition";

    /// <summary>
    ///     Recursively finds sagas in a namespace.
    /// </summary>
    private static void FindSagasInNamespace(
        INamespaceSymbol namespaceSymbol,
        INamedTypeSymbol sagaAttrSymbol,
        INamedTypeSymbol sagaDefinitionSymbol,
        string targetRootNamespace,
        List<SagaRegistrationInfo> sagas
    )
    {
        foreach (INamedTypeSymbol typeSymbol in namespaceSymbol.GetTypeMembers())
        {
            SagaRegistrationInfo? info = TryGetSagaRegistrationInfo(
                typeSymbol,
                sagaAttrSymbol,
                sagaDefinitionSymbol,
                targetRootNamespace);
            if (info is not null)
            {
                sagas.Add(info);
            }
        }

        foreach (INamespaceSymbol childNs in namespaceSymbol.GetNamespaceMembers())
        {
            FindSagasInNamespace(childNs, sagaAttrSymbol, sagaDefinitionSymbol, targetRootNamespace, sagas);
        }
    }

    /// <summary>
    ///     Generates the registration extension method for a saga.
    /// </summary>
    private static void GenerateRegistration(
        SourceProductionContext context,
        SagaRegistrationInfo saga
    )
    {
        string registrationClassName = $"{saga.SagaName}SagaFeatureRegistrations";
        string extensionMethodName = $"Add{saga.SagaName}SagaFeature";
        string actionName = $"Start{saga.SagaName}SagaAction";
        string executingActionName = $"Start{saga.SagaName}SagaExecutingAction";
        string succeededActionName = $"Start{saga.SagaName}SagaSucceededAction";
        string failedActionName = $"Start{saga.SagaName}SagaFailedAction";
        string dtoName = $"Start{saga.SagaName}SagaDto";
        string stateName = $"{saga.SagaName}SagaFeatureState";
        string executingReducerName = $"Start{saga.SagaName}SagaExecutingReducer";
        string succeededReducerName = $"Start{saga.SagaName}SagaSucceededReducer";
        string failedReducerName = $"Start{saga.SagaName}SagaFailedReducer";
        string mapperName = $"Start{saga.SagaName}SagaActionMapper";
        string effectName = $"Start{saga.SagaName}SagaActionEffect";
        SourceBuilder sb = new();
        sb.AppendAutoGeneratedHeader();
        sb.AppendUsing("Microsoft.Extensions.DependencyInjection");
        sb.AppendUsing("Mississippi.Common.Abstractions.Mapping");
        sb.AppendUsing("Mississippi.Reservoir");
        sb.AppendUsing("Mississippi.Reservoir.Abstractions");
        sb.AppendUsing("Mississippi.Reservoir.Abstractions.State");
        sb.AppendUsing(saga.ActionsNamespace);
        sb.AppendUsing(saga.DtosNamespace);
        sb.AppendUsing(saga.MappersNamespace);
        sb.AppendUsing(saga.ReducersNamespace);
        sb.AppendUsing(saga.StateNamespace);
        sb.AppendUsing(saga.EffectsNamespace);
        sb.AppendFileScopedNamespace(saga.RegistrationNamespace);
        sb.AppendLine();
        sb.AppendSummary($"Service registration extensions for {saga.SagaName} saga feature.");
        sb.AppendGeneratedCodeAttribute(GeneratorName);
        sb.AppendLine($"public static class {registrationClassName}");
        sb.OpenBrace();

        // Extension method
        sb.AppendSummary($"Adds the {saga.SagaName} saga feature to the service collection.");
        sb.AppendLine("/// <param name=\"services\">The service collection.</param>");
        sb.AppendLine("/// <returns>The service collection for chaining.</returns>");
        sb.AppendLine($"public static IServiceCollection {extensionMethodName}(this IServiceCollection services)");
        sb.OpenBrace();

        // Register reducers using the correct extension method
        sb.AppendLine("// Register reducers");
        sb.AppendLine($"services.AddReducer<{executingActionName}, {stateName}, {executingReducerName}>();");
        sb.AppendLine($"services.AddReducer<{succeededActionName}, {stateName}, {succeededReducerName}>();");
        sb.AppendLine($"services.AddReducer<{failedActionName}, {stateName}, {failedReducerName}>();");
        sb.AppendLine();

        // Register mapper
        sb.AppendLine("// Register mapper");
        sb.AppendLine($"services.AddTransient<IMapper<{actionName}, {dtoName}>, {mapperName}>();");
        sb.AppendLine();

        // Register action effect
        sb.AppendLine("// Register action effect");
        sb.AppendLine($"services.AddActionEffect<{stateName}, {effectName}>();");
        sb.AppendLine();
        sb.AppendLine("return services;");
        sb.CloseBrace();
        sb.CloseBrace();
        context.AddSource($"{registrationClassName}.g.cs", SourceText.From(sb.ToString(), Encoding.UTF8));
    }

    /// <summary>
    ///     Gets all referenced assemblies from the compilation.
    /// </summary>
    private static IEnumerable<IAssemblySymbol> GetReferencedAssemblies(
        Compilation compilation
    )
    {
        yield return compilation.Assembly;
        foreach (MetadataReference reference in compilation.References)
        {
            if (compilation.GetAssemblyOrModuleSymbol(reference) is IAssemblySymbol assemblySymbol)
            {
                yield return assemblySymbol;
            }
        }
    }

    /// <summary>
    ///     Gets saga information from the compilation.
    /// </summary>
    private static List<SagaRegistrationInfo> GetSagasFromCompilation(
        Compilation compilation,
        string targetRootNamespace
    )
    {
        List<SagaRegistrationInfo> sagas = [];
        INamedTypeSymbol? sagaAttrSymbol = compilation.GetTypeByMetadataName(GenerateSagaEndpointsAttributeFullName);
        INamedTypeSymbol? sagaDefinitionSymbol = compilation.GetTypeByMetadataName(ISagaDefinitionFullName);
        if (sagaAttrSymbol is null || sagaDefinitionSymbol is null)
        {
            return sagas;
        }

        foreach (IAssemblySymbol referencedAssembly in GetReferencedAssemblies(compilation))
        {
            FindSagasInNamespace(
                referencedAssembly.GlobalNamespace,
                sagaAttrSymbol,
                sagaDefinitionSymbol,
                targetRootNamespace,
                sagas);
        }

        return sagas;
    }

    /// <summary>
    ///     Tries to get saga registration info from a type symbol.
    /// </summary>
    private static SagaRegistrationInfo? TryGetSagaRegistrationInfo(
        INamedTypeSymbol typeSymbol,
        INamedTypeSymbol sagaAttrSymbol,
        INamedTypeSymbol sagaDefinitionSymbol,
        string targetRootNamespace
    )
    {
        AttributeData? attr = typeSymbol.GetAttributes()
            .FirstOrDefault(a => SymbolEqualityComparer.Default.Equals(a.AttributeClass, sagaAttrSymbol));
        if (attr is null)
        {
            return null;
        }

        bool implementsSagaDefinition = typeSymbol.AllInterfaces.Any(i =>
            SymbolEqualityComparer.Default.Equals(i, sagaDefinitionSymbol));
        if (!implementsSagaDefinition)
        {
            return null;
        }

        TypedConstant inputTypeArg = attr.NamedArguments.FirstOrDefault(kvp => kvp.Key == "InputType").Value;
        if (inputTypeArg.IsNull || inputTypeArg.Value is not INamedTypeSymbol)
        {
            return null;
        }

        // Extract saga name
        string sagaName = typeSymbol.Name;
        if (sagaName.EndsWith("SagaState", StringComparison.Ordinal))
        {
            sagaName = sagaName.Substring(0, sagaName.Length - "SagaState".Length);
        }
        else if (sagaName.EndsWith("Saga", StringComparison.Ordinal))
        {
            sagaName = sagaName.Substring(0, sagaName.Length - "Saga".Length);
        }

        string domainNamespace = typeSymbol.ContainingNamespace.ToDisplayString();
        string actionsNamespace = NamingConventions.GetClientSagaFeatureNamespace(
            domainNamespace,
            targetRootNamespace,
            "Actions");
        string dtosNamespace = NamingConventions.GetClientSagaFeatureNamespace(
            domainNamespace,
            targetRootNamespace,
            "Dtos");
        string mappersNamespace = NamingConventions.GetClientSagaFeatureNamespace(
            domainNamespace,
            targetRootNamespace,
            "Mappers");
        string stateNamespace = NamingConventions.GetClientSagaFeatureNamespace(
            domainNamespace,
            targetRootNamespace,
            "State");
        string reducersNamespace = NamingConventions.GetClientSagaFeatureNamespace(
            domainNamespace,
            targetRootNamespace,
            "Reducers");
        string effectsNamespace = NamingConventions.GetClientSagaFeatureNamespace(
            domainNamespace,
            targetRootNamespace,
            "ActionEffects");
        string registrationNamespace = NamingConventions.GetClientSagaFeatureNamespace(
            domainNamespace,
            targetRootNamespace,
            "Registration");
        return new(
            sagaName,
            actionsNamespace,
            dtosNamespace,
            mappersNamespace,
            stateNamespace,
            reducersNamespace,
            effectsNamespace,
            registrationNamespace);
    }

    /// <inheritdoc />
    public void Initialize(
        IncrementalGeneratorInitializationContext context
    )
    {
        IncrementalValueProvider<(Compilation Compilation, AnalyzerConfigOptionsProvider Options)>
            compilationAndOptions = context.CompilationProvider.Combine(context.AnalyzerConfigOptionsProvider);
        IncrementalValueProvider<List<SagaRegistrationInfo>> sagasProvider = compilationAndOptions.Select((
            source,
            _
        ) =>
        {
            source.Options.GlobalOptions.TryGetValue(
                TargetNamespaceResolver.RootNamespaceProperty,
                out string? rootNamespace);
            source.Options.GlobalOptions.TryGetValue(
                TargetNamespaceResolver.AssemblyNameProperty,
                out string? assemblyName);
            string targetRootNamespace = TargetNamespaceResolver.GetTargetRootNamespace(
                rootNamespace,
                assemblyName,
                source.Compilation);
            return GetSagasFromCompilation(source.Compilation, targetRootNamespace);
        });
        context.RegisterSourceOutput(
            sagasProvider,
            static (
                spc,
                sagas
            ) =>
            {
                foreach (SagaRegistrationInfo saga in sagas)
                {
                    GenerateRegistration(spc, saga);
                }
            });
    }

    /// <summary>
    ///     Information about a saga for registration generation.
    /// </summary>
    private sealed class SagaRegistrationInfo
    {
        public SagaRegistrationInfo(
            string sagaName,
            string actionsNamespace,
            string dtosNamespace,
            string mappersNamespace,
            string stateNamespace,
            string reducersNamespace,
            string effectsNamespace,
            string registrationNamespace
        )
        {
            SagaName = sagaName;
            ActionsNamespace = actionsNamespace;
            DtosNamespace = dtosNamespace;
            MappersNamespace = mappersNamespace;
            StateNamespace = stateNamespace;
            ReducersNamespace = reducersNamespace;
            EffectsNamespace = effectsNamespace;
            RegistrationNamespace = registrationNamespace;
        }

        public string ActionsNamespace { get; }

        public string DtosNamespace { get; }

        public string EffectsNamespace { get; }

        public string MappersNamespace { get; }

        public string ReducersNamespace { get; }

        public string RegistrationNamespace { get; }

        public string SagaName { get; }

        public string StateNamespace { get; }
    }
}