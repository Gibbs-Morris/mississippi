using System;
using System.Text;

using Microsoft.CodeAnalysis;
using Microsoft.CodeAnalysis.Text;

using Mississippi.Inlet.Generators.Core.Emit;
using Mississippi.Inlet.Generators.Core.Naming;


namespace Mississippi.Inlet.Silo.Generators;

/// <summary>
///     Generates Spring domain registration wrappers for silo projects.
/// </summary>
[Generator(LanguageNames.CSharp)]
public sealed class SpringDomainSiloRegistrationGenerator : IIncrementalGenerator
{
    private const string SpringSiloRootNamespace = "Spring.Silo";

    /// <inheritdoc />
    public void Initialize(
        IncrementalGeneratorInitializationContext context
    )
    {
        IncrementalValueProvider<(Compilation Compilation, AnalyzerConfigOptionsProvider Options)> source =
            context.CompilationProvider.Combine(context.AnalyzerConfigOptionsProvider);
        context.RegisterSourceOutput(
            source,
            static (
                spc,
                value
            ) =>
            {
                string targetRootNamespace = ResolveTargetRootNamespace(value.Compilation, value.Options);
                if (!string.Equals(targetRootNamespace, SpringSiloRootNamespace, StringComparison.Ordinal))
                {
                    return;
                }

                SourceBuilder sb = new();
                sb.AppendAutoGeneratedHeader();
                sb.AppendUsing("System");
                sb.AppendUsing("Mississippi.Common.Abstractions.Builders");
                sb.AppendFileScopedNamespace("Spring.Silo.Registrations");
                sb.AppendLine();
                sb.AppendSummary("Extension methods for registering the Spring domain silo services.");
                sb.AppendGeneratedCodeAttribute("SpringDomainSiloRegistrationGenerator");
                sb.AppendLine("public static class SpringDomainSiloRegistrations");
                sb.OpenBrace();
                sb.AppendSummary("Adds Spring domain silo registrations generated from the domain project.");
                sb.AppendLine("/// <param name=\"builder\">The Mississippi silo builder.</param>");
                sb.AppendLine("/// <returns>The builder for chaining.</returns>");
                sb.AppendLine("public static IMississippiSiloBuilder AddSpringDomain(");
                sb.IncreaseIndent();
                sb.AppendLine("this IMississippiSiloBuilder builder");
                sb.DecreaseIndent();
                sb.AppendLine(")");
                sb.OpenBrace();
                sb.AppendLine("ArgumentNullException.ThrowIfNull(builder);");
                sb.AppendLine("builder.AddBankAccountAggregate();");
                sb.AppendLine("builder.AddTransactionInvestigationQueueAggregate();");
                sb.AppendLine("builder.AddMoneyTransferSaga();");
                sb.AppendLine("builder.AddBankAccountBalanceProjection();");
                sb.AppendLine("builder.AddBankAccountLedgerProjection();");
                sb.AppendLine("builder.AddFlaggedTransactionsProjection();");
                sb.AppendLine("builder.AddMoneyTransferStatusProjection();");
                sb.AppendLine("return builder;");
                sb.CloseBrace();
                sb.CloseBrace();
                spc.AddSource(
                    "SpringDomainSiloRegistrations.g.cs",
                    SourceText.From(sb.ToString(), Encoding.UTF8));
            });
    }

    private static string ResolveTargetRootNamespace(
        Compilation compilation,
        AnalyzerConfigOptionsProvider optionsProvider
    )
    {
        optionsProvider.GlobalOptions.TryGetValue(
            TargetNamespaceResolver.RootNamespaceProperty,
            out string? rootNamespace);
        optionsProvider.GlobalOptions.TryGetValue(
            TargetNamespaceResolver.AssemblyNameProperty,
            out string? assemblyName);
        return TargetNamespaceResolver.GetTargetRootNamespace(rootNamespace, assemblyName, compilation);
    }
}
