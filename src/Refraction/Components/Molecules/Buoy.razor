@namespace Refraction.Components.Molecules

<div class="@CssClass"
     role="@RoleValue"
     aria-live="@AriaLiveValue"
     aria-label="@AriaLabel"
     tabindex="@TabIndexValue"
     @onclick="@(async () =>
               {
                   if (IsInteractive) await OnClick.InvokeAsync();
               })">
    <div class="rf-buoy__indicator">
        @if (Count.HasValue && (Count.Value > 0))
        {
            <span class="rf-buoy__count">@DisplayCount</span>
        }
    </div>
    @if (ShowPulse)
    {
        <div class="rf-buoy__pulse"></div>
    }
</div>

@code {

    /// <summary>
    ///     Gets or sets the semantic state of the buoy.
    /// </summary>
    [Parameter]
    public BuoyState State { get; set; } = BuoyState.Info;

    /// <summary>
    ///     Gets or sets the size variant.
    /// </summary>
    [Parameter]
    public BuoySize Size { get; set; } = BuoySize.Default;

    /// <summary>
    ///     Gets or sets the optional count to display (e.g., notification count).
    /// </summary>
    [Parameter]
    public int? Count { get; set; }

    /// <summary>
    ///     Gets or sets the maximum count before showing "N+".
    /// </summary>
    [Parameter]
    public int MaxCount { get; set; } = 99;

    /// <summary>
    ///     Gets or sets whether to show a pulse animation for urgency.
    /// </summary>
    [Parameter]
    public bool ShowPulse { get; set; }

    /// <summary>
    ///     Gets or sets whether the buoy is interactive.
    /// </summary>
    [Parameter]
    public bool IsInteractive { get; set; }

    /// <summary>
    ///     Gets or sets the accessible label for the buoy.
    /// </summary>
    [Parameter]
    public string AriaLabel { get; set; } = "Status indicator";

    /// <summary>
    ///     Gets or sets additional CSS classes to apply.
    /// </summary>
    [Parameter]
    public string? Class { get; set; }

    /// <summary>
    ///     Event callback fired when the buoy is clicked (if interactive).
    /// </summary>
    [Parameter]
    public EventCallback OnClick { get; set; }

    private string CssClass => BuildCssClass();

    private string DisplayCount => Count > MaxCount ? $"{MaxCount}+" : Count?.ToString() ?? "";

    private string RoleValue => IsInteractive ? "button" : "status";

    private string AriaLiveValue => State is BuoyState.Critical or BuoyState.Warning ? "assertive" : "polite";

    private string? TabIndexValue => IsInteractive ? "0" : null;

    private string BuildCssClass()
    {
        List<string> classes = new()
        {
            "rf-buoy",
            GetStateClass(),
            GetSizeClass(),
        };
        if (ShowPulse)
        {
            classes.Add("rf-buoy--pulsing");
        }

        if (IsInteractive)
        {
            classes.Add("rf-buoy--interactive");
        }

        if (Count.HasValue && (Count.Value > 0))
        {
            classes.Add("rf-buoy--has-count");
        }

        if (!string.IsNullOrEmpty(Class))
        {
            classes.Add(Class);
        }

        return string.Join(" ", classes);
    }

    private string GetStateClass() =>
        State switch
        {
            BuoyState.Info => "rf-buoy--info",
            BuoyState.Success => "rf-buoy--success",
            BuoyState.Warning => "rf-buoy--warning",
            BuoyState.Critical => "rf-buoy--critical",
            var _ => "rf-buoy--info",
        };

    private string GetSizeClass() =>
        Size switch
        {
            BuoySize.Small => "rf-buoy--small",
            BuoySize.Default => "rf-buoy--default",
            BuoySize.Large => "rf-buoy--large",
            var _ => "rf-buoy--default",
        };

}