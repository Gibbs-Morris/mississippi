using System;
using System.IO;
using System.Text;
using System.Threading;
using System.Threading.Tasks;

using Mississippi.DocumentationGenerator.Output;


namespace Mississippi.DocumentationGenerator.Reports;

/// <summary>
///     Generates the main index page for generated documentation.
/// </summary>
public sealed class IndexReport : IDocumentationReport
{
    private DocumentationWriter Writer { get; }

    /// <summary>
    ///     Initializes a new instance of the <see cref="IndexReport" /> class.
    /// </summary>
    /// <param name="writer">The documentation writer.</param>
    public IndexReport(
        DocumentationWriter writer
    )
    {
        Writer = writer;
    }

    /// <inheritdoc />
    public string Name => "Index";

    /// <inheritdoc />
    public string Description => "Generates the main index page for generated documentation";

    /// <inheritdoc />
    public int Order => 0;

    /// <inheritdoc />
    public Task GenerateAsync(
        ReportContext context,
        CancellationToken cancellationToken = default
    )
    {
        ArgumentNullException.ThrowIfNull(context);

        StringBuilder content = new();

        content.AppendLine("Welcome to the auto-generated documentation for the Mississippi framework.");
        content.AppendLine();
        content.AppendLine("## Available Documentation");
        content.AppendLine();
        content.AppendLine("This section contains automatically generated documentation derived from the codebase:");
        content.AppendLine();
        content.AppendLine("- **[Dependencies](./dependencies)** - Project dependency graphs and references");
        content.AppendLine("- **[Orleans Grains](./grains)** - Orleans grain call mapping and classifications");
        content.AppendLine();
        content.AppendLine("## About This Documentation");
        content.AppendLine();
        content.AppendLine("This documentation is generated by analyzing the repository's .NET code and project structure.");
        content.AppendLine("It provides visual representations of:");
        content.AppendLine();
        content.AppendLine("- Project references between solutions");
        content.AppendLine("- Orleans grain relationships and classifications");
        content.AppendLine("- Read-only, stateless worker, and reentrant grain attributes");

        string indexPath = Path.Combine(context.OutputDirectory, "index.mdx");
        Writer.WriteMdxFile(indexPath, "Generated Documentation", content.ToString(), 1);

        return Task.CompletedTask;
    }
}
